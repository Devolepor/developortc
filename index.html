<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #1976d2;
      --primary-dark: #125ea5;
      --danger-color: #e53935;
      --warning-color: #ff9800;
      --success-color: #43a047;
      --text-color: #2d3748;
      --text-light: #4a5568;
      --light-bg: #f8fafc;
      --white: #ffffff;
      --gray-light: #e2e8f0;
      --gray-dark: #cbd5e0;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .dark-mode {
      --primary-color: #4299e1;
      --primary-dark: #3182ce;
      --danger-color: #fc8181;
      --warning-color: #f6ad55;
      --success-color: #68d391;
      --text-color: #e2e8f0;
      --text-light: #a0aec0;
      --light-bg: #1a202c;
      --white: #2d3748;
      --gray-light: #4a5568;
      --gray-dark: #2d3748;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: var(--light-bg);
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      transition: var(--transition);
    }
    
    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      transition: var(--transition);
    }
    

/* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª */
.student-group {
  background-color: #4a6baf;
  color: white;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 12px;
  margin-right: 5px;
}

.group-Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©-Ø£ {
  border-left: 4px solid #4CAF50;
}

.group-Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©-Ø¨ {
  border-left: 4px solid #2196F3;
}

.group-Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©-Ø¬ {
  border-left: 4px solid #FFC107;
}

.group-Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©-Ø¯ {
  border-left: 4px solid #F44336;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© */
.grade-select {
  display: flex;
  gap: 10px;
}

.btn {
  display: flex;
  align-items: center;
  gap: 5px;
}

    .sidebar {
      position: fixed;
      right: -100%;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: var(--white);
      box-shadow: var(--shadow);
      transition: var(--transition);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }
    
    .sidebar.open {
      right: 0;
    }
    
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .sidebar-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .sidebar-menu {
      list-style: none;
    }
    
    .sidebar-menu li {
      margin-bottom: 10px;
    }
    
    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 15px;
      border-radius: var(--radius);
      color: var(--text-color);
      text-decoration: none;
      transition: var(--transition);
      font-weight: 500;
      background-color: var(--light-bg);
    }
    
    .sidebar-menu a:hover {
      background-color: var(--primary-color);
      color: var(--white);
      transform: translateX(-5px);
    }
    
    .sidebar-menu a i {
      margin-left: 10px;
      font-size: 18px;
    }
    
    .sidebar-toggle {
      position: fixed;
      right: 20px;
      top: 20px;
      background-color: var(--primary-color);
      color: var(--white);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1001;
      box-shadow: var(--shadow);
      font-size: 20px;
      transition: var(--transition);
    }
    
    .sidebar-toggle:hover {
      transform: scale(1.1);
    }
    
    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 15px 0;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .header h1 {
      color: var(--primary-color);
      font-size: 24px;
      font-weight: 700;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .grade-select {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    input, button, select, textarea {
      padding: 12px 15px;
      border-radius: var(--radius);
      border: 1px solid var(--gray-light);
      font-family: 'Tajawal', sans-serif;
      font-size: 16px;
      transition: var(--transition);
      width: 100%;
      background-color: var(--white);
      color: var(--text-color);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }
    
    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .btn {
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
      transition: var(--transition);
      box-shadow: var(--shadow);
      padding: 12px 20px;
      border-radius: 8px;
    }
    
    .btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-danger {
      background-color: var(--danger-color);
    }
    
    .btn-danger:hover {
      background-color: #c62828;
    }
    
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-success:hover {
      background-color: #2e7d32;
    }
    
    .btn-warning {
      background-color: var(--warning-color);
    }
    
    .btn-warning:hover {
      background-color: #e65100;
    }
    
    .btn-secondary {
      background-color: var(--gray-light);
      color: var(--text-color);
    }
    
    .btn-secondary:hover {
      background-color: var(--gray-dark);
    }
    
    .btn-small {
      padding: 8px 15px;
      font-size: 14px;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn-group .btn {
      flex: 1;
      min-width: 120px;
    }
    
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--white) 0%, var(--light-bg) 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      animation: fadeIn 0.5s ease;
    }
    
    .login-box {
      background: var(--white);
      padding: 30px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 400px;
      text-align: center;
      transform: scale(0.9);
      animation: popIn 0.4s ease forwards;
    }
    
    @keyframes popIn {
      0% { transform: scale(0.9); opacity: 0; }
      80% { transform: scale(1.05); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .login-box h2 {
      margin-bottom: 25px;
      color: var(--primary-color);
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .login-box input {
      margin-bottom: 20px;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1050;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      overflow-y: auto;
      padding: 0;
      box-sizing: border-box;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background-color: var(--white);
      padding: 25px;
      border-radius: 0;
      width: 100%;
      min-height: 100vh;
      box-shadow: none;
      margin: 0;
      position: relative;
      animation: slideIn 0.3s ease forwards;
      z-index: 1051;
    }
    
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--gray-light);
    }
    

.weekly-reports-container {
    background: var(--white);
    border-radius: var(--radius);
    padding: 20px;
    margin-top: 20px;
    box-shadow: var(--shadow);
}

.weekly-report-item {
    background: var(--light-bg);
    border-radius: var(--radius);
    padding: 15px;
    margin-bottom: 10px;
    border-left: 4px solid var(--primary-color);
}

.report-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 1px dashed var(--gray-light);
}

.report-date {
    font-weight: bold;
    color: var(--primary-color);
}

.report-actions {
    display: flex;
    gap: 5px;
}

.report-details {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
}

.report-details div {
    padding: 5px;
    background: rgba(255,255,255,0.7);
    border-radius: 5px;
}




    .modal-title {
      margin: 0;
      color: var(--primary-color);
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close {
      color: var(--text-light);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
      background: var(--light-bg);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .close:hover {
      color: var(--danger-color);
      background: rgba(229, 57, 53, 0.1);
      transform: rotate(90deg);
    }
    
    .modal-body {
      padding: 15px 0;
    }
    
    .modal-footer {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-top: 20px;
      border-top: 1px solid var(--gray-light);
      margin-top: 20px;
      position: sticky;
      bottom: 0;
      background: var(--white);
      padding-bottom: 20px;
    }
    
    .modal-footer button {
      width: 100%;
    }
    
    .image-upload-container {
      background: var(--light-bg);
      padding: 20px;
      border-radius: 12px;
      margin-top: 10px;
    }
    
    .image-preview-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .image-preview {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px dashed var(--gray-light);
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow);
      display: none;
    }
    
    .image-preview:hover {
      transform: scale(1.03);
      border-color: var(--primary-color);
    }
    
    .image-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      width: 100%;
      margin-top: 10px;
      display: none;
    }
    
    .upload-btn {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    
    .upload-btn input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .image-modal .modal-content {
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      padding: 20px;
    }
    
    .image-modal-content {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 8px;
      box-shadow: 0 5px 30px rgba(0,0,0,0.3);
      animation: zoomIn 0.3s ease;
    }
    
    @keyframes zoomIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    .close-image {
      position: fixed;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1002;
      background: rgba(0,0,0,0.5);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
    }
    
    .close-image:hover {
      transform: rotate(90deg);
      background: rgba(0,0,0,0.8);
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--gray-light);
      overflow-x: auto;
      padding-bottom: 5px;
    }
    
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
      white-space: nowrap;
      font-weight: 500;
    }
    
    .tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    #studentsCards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    
    .student-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 15px;
      transition: var(--transition);
      position: relative;
    }
    
    .student-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    
    .student-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-light);
      cursor: pointer;
    }
    
    .student-id {
      font-weight: bold;
      color: var(--primary-color);
      font-size: 16px;
    }
    
    .student-name {
      font-weight: bold;
      font-size: 18px;
    }
    
    .student-grade {
      color: var(--text-light);
      font-size: 14px;
    }
    
    .student-level {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .level-weak {
      background-color: #ffebee;
      color: #c62828;
    }
    
    .level-acceptable {
      background-color: #fff8e1;
      color: #e65100;
    }
    
    .level-good {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    
    .level-very-good {
      background-color: #e3f2fd;
      color: #1565c0;
    }
    
    .level-excellent {
      background-color: #f3e5f5;
      color: #6a1b9a;
    }
    
    .student-image-thumb {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--gray-light);
    }
    
    .posts-container {
      margin-top: 30px;
    }
    
    .posts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .post {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
      transition: var(--transition);
    }
    
    .post:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .post-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .post-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-left: 15px;
    }
    
    .post-author {
      font-weight: bold;
    }
    
    .post-date {
      color: var(--text-light);
      font-size: 14px;
    }
    
    .post-content {
      margin-bottom: 15px;
      line-height: 1.6;
    }
    
    .post-image {
      max-width: 100%;
      border-radius: 8px;
      margin: 10px 0;
      display: block;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .post-image:hover {
      transform: scale(1.02);
    }
    
    .post-actions {
      display: flex;
      gap: 15px;
      border-top: 1px solid var(--gray-light);
      padding-top: 15px;
      flex-wrap: wrap;
    }
    
    .post-action {
      display: flex;
      align-items: center;
      gap: 5px;
      color: var(--text-light);
      cursor: pointer;
      transition: var(--transition);
      padding: 8px 12px;
      border-radius: 20px;
      background-color: var(--light-bg);
    }
    
    .post-action:hover {
      color: var(--primary-color);
      background-color: rgba(25, 118, 210, 0.1);
    }
    
    .post-action.liked {
      color: var(--danger-color);
      background-color: rgba(229, 57, 53, 0.1);
    }
    
    .post-delete {
      position: absolute;
      top: 15px;
      left: 15px;
      color: var(--danger-color);
      cursor: pointer;
      opacity: 0.7;
      transition: var(--transition);
    }
    
    .post-delete:hover {
      opacity: 1;
      transform: scale(1.2);
    }
    
    .student-detail-card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }
    
    .student-detail-header {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .student-detail-title {
      color: var(--primary-color);
      font-size: 22px;
      margin: 0;
    }
    
    .student-info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 10px;
      background-color: var(--light-bg);
      border-radius: var(--radius);
    }
    
    .student-info-label {
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .student-info-value {
      color: var(--text-color);
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 20px;
    }
    
    .qr-code-container {
      margin: 20px 0;
      text-align: center;
    }
    
    .qr-code {
      margin: 0 auto;
      padding: 10px;
      background: white;
      border-radius: var(--radius);
      display: inline-block;
    }
    
    .attendance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .attendance-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: var(--light-bg);
      border-radius: var(--radius);
    }
    
    .fees-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .fee-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: var(--light-bg);
      border-radius: var(--radius);
    }
    
    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .report-table th, .report-table td {
      padding: 12px;
      text-align: right;
      border: 1px solid var(--gray-light);
    }
    
    .report-table th {
      background-color: var(--primary-color);
      color: white;
    }
    
    .report-table tr:nth-child(even) {
      background-color: var(--light-bg);
    }
    
    .report-table tr:hover {
      background-color: rgba(25, 118, 210, 0.1);
    }
    
    .report-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .report-filter select {
      flex: 1;
      min-width: 150px;
    }
    
    .trash-list {
      margin-top: 20px;
    }
    
    .trash-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 10px;
      transition: var(--transition);
    }
    
    .trash-item:hover {
      transform: translateY(-2px);
    }
    
    .trash-info {
      flex: 1;
    }
    
    .trash-actions {
      display: flex;
      gap: 10px;
    }
    
    .no-students {
      text-align: center;
      padding: 40px;
      background: var(--white);
      border-radius: 12px;
      box-shadow: var(--shadow);
    }
    
    .no-students h3 {
      color: var(--text-light);
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--white);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .report-type-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .report-type-btn {
      flex: 1;
      min-width: 200px;
    }
    
    .report-section {
      display: none;
    }
    
    .report-section.active {
      display: block;
    }
    
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      text-align: center;
      transition: var(--transition);
    }
    
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .stat-card h3 {
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .stat-card .description {
      color: var(--text-light);
      font-size: 14px;
    }
    
    .stat-card.present {
      border-top: 4px solid var(--success-color);
    }
    
    .stat-card.absent {
      border-top: 4px solid var(--danger-color);
    }
    
    .stat-card.paid {
      border-top: 4px solid var(--success-color);
    }
    
    .stat-card.unpaid {
      border-top: 4px solid var(--danger-color);
    }
    
    .stat-card.total {
      border-top: 4px solid var(--primary-color);
    }
    
    .edit-student-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      color: var(--warning-color);
      cursor: pointer;
      opacity: 0.7;
      transition: var(--transition);
    }
    
    .edit-student-btn:hover {
      opacity: 1;
      transform: scale(1.2);
    }
    
    .file-info {
      background: var(--light-bg);
      padding: 15px;
      border-radius: var(--radius);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .file-info span {
      font-weight: bold;
      color: var(--primary-color);
    }
    
    /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
    .student-id-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 20px;
      max-width: 400px;
      margin: 20px auto;
      text-align: center;
      border: 1px solid #eee;
    }
    
    .student-id-card-header {
      background: var(--primary-color);
      color: white;
      padding: 15px;
      border-radius: 8px 8px 0 0;
      margin: -20px -20px 20px -20px;
    }
    
    .student-id-card-title {
      font-size: 18px;
      font-weight: bold;
      margin: 0;
    }
    
    .student-id-card-body {
      padding: 10px 0;
    }
    
    .student-id-card-photo {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary-color);
      margin: 0 auto 15px;
    }
    
    .student-id-card-info {
      text-align: right;
      margin-bottom: 15px;
    }
    
    .student-id-card-info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #eee;
    }
    
    .student-id-card-info-label {
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .student-id-card-footer {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    
    .share-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .share-btn {
      padding: 10px 15px;
      border-radius: 8px;
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .share-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    
    .whatsapp {
      background-color: #25D366;
    }
    
    .telegram {
      background-color: #0088cc;
    }
    
    .download-card {
      background-color: var(--primary-color);
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù‡Ø§ØªÙ */
    @media (min-width: 768px) {
      .sidebar {
        width: 300px;
        right: -300px;
      }
      
      .modal-content {
        width: 90%;
        max-width: 600px;
        min-height: auto;
        border-radius: 16px;
        margin: 30px auto;
      }
      
      .modal-footer {
        flex-direction: row;
        justify-content: flex-end;
      }
      
      .modal-footer button {
        width: auto;
      }
      
      .action-buttons {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
    }
    
    @media (max-width: 480px) {
      .header h1 {
        font-size: 20px;
      }
      
      .control-panel {
        grid-template-columns: 1fr;
      }
      
      .sidebar-menu a {
        padding: 12px;
        font-size: 15px;
      }
      
      .modal-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .modal-title {
        font-size: 20px;
      }
      
      .student-card {
        padding: 12px;
      }
      
      .student-name {
        font-size: 16px;
      }
      
      .student-id {
        font-size: 14px;
      }
      
      .share-buttons {
        flex-direction: column;
      }
    }
    
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--gray-light);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      z-index: 1100;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .popup-content {
      background-color: var(--white);
      border-radius: var(--radius);
      padding: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow);
      animation: popIn 0.3s ease;
    }

    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-light);
    }

    .popup-title {
      font-size: 18px;
      font-weight: bold;
      color: var(--primary-color);
    }

    .popup-close {
      cursor: pointer;
      font-size: 24px;
      color: var(--danger-color);
    }

    .popup-body {
      margin-bottom: 20px;
    }

    .popup-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .status-select {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--gray-light);
      width: 100%;
      margin-bottom: 10px;
    }

    .status-option {
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 5px;
      cursor: pointer;
      transition: var(--transition);
    }

    .status-option:hover {
      background-color: var(--light-bg);
    }

    .status-option.present {
      background-color: #e8f5e9;
      color: #2e7d32;
    }

    .status-option.absent {
      background-color: #ffebee;
      color: #c62828;
    }

    .status-option.paid {
      background-color: #e8f5e9;
      color: #2e7d32;
    }

    .status-option.unpaid {
      background-color: #fff8e1;
      color: #e65100;
    }

    .status-icon {
      margin-left: 10px;
      font-size: 18px;
    }

    .status-label {
      flex: 1;
    }

    .month-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .month-item {
      padding: 10px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--gray-light);
    }

    .month-item.selected {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-dark);
    }

    .month-item.paid {
      background-color: #e8f5e9;
      border-color: #a5d6a7;
    }

    .month-item.unpaid {
      background-color: #ffebee;
      border-color: #ef9a9a;
    }

    .day-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .day-item {
      padding: 10px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--gray-light);
    }

    .day-item.selected {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-dark);
    }

    .day-item.present {
      background-color: #e8f5e9;
      border-color: #a5d6a7;
    }

    .day-item.absent {
      background-color: #ffebee;
      border-color: #ef9a9a;
    }

    .excel-btn {
      background-color: #1d6f42;
    }

    .excel-btn:hover {
      background-color: #165834;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
    .modal-stack {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1050;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-stack .modal {
      position: absolute;
      z-index: inherit;
    }

    .modal-stack .modal:nth-child(1) {
      z-index: 1051;
    }

    .modal-stack .modal:nth-child(2) {
      z-index: 1052;
      transform: scale(0.95);
    }

    .modal-stack .modal:nth-child(3) {
      z-index: 1053;
      transform: scale(0.9);
    }

    .modal-stack .modal-content {
      min-height: auto;
      max-height: 90vh;
      overflow-y: auto;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
    .notes-container {
      background: var(--white);
      border-radius: var(--radius);
      padding: 20px;
      margin-top: 20px;
      box-shadow: var(--shadow);
    }

    .notes-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .notes-content {
      background: var(--light-bg);
      padding: 15px;
      border-radius: var(--radius);
      min-height: 100px;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© */
    .weekly-report {
      background: var(--white);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .report-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .report-form-group {
      margin-bottom: 15px;
    }

    .report-form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: var(--primary-color);
    }

    .report-form-group input, 
    .report-form-group select, 
    .report-form-group textarea {
      width: 100%;
      padding: 10px;
      border-radius: var(--radius);
      border: 1px solid var(--gray-light);
    }

    .report-form-group textarea {
      min-height: 100px;
    }

    .report-preview {
      background: var(--light-bg);
      padding: 20px;
      border-radius: var(--radius);
      margin-top: 20px;
    }

    .report-template {
      font-family: 'Tajawal', sans-serif;
      line-height: 1.6;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .report-template h3 {
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 15px;
    }

    .report-template p {
      margin-bottom: 10px;
    }

    .report-template .report-date {
      text-align: left;
      color: var(--text-light);
      font-size: 14px;
    }

    .report-template .report-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px dashed var(--gray-light);
    }

    .report-template .report-item:last-child {
      border-bottom: none;
    }

    .report-template .report-item-label {
      font-weight: bold;
    }

    .report-template .report-footer {
      margin-top: 20px;
      text-align: center;
      font-style: italic;
      color: var(--text-light);
    }
    /* Ø£Ù†Ù…Ø§Ø· Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ - Ù†Ø³Ø®Ø© Ù…Ø·ÙˆØ±Ø© */
.attendance-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-bottom: 20px;
  padding: 20px;
  border-bottom: 2px solid var(--gray-light);
  background: var(--white);
  border-radius: 12px;
  box-shadow: var(--shadow);
}

.filter-section {
  flex: 1;
  min-width: 300px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
}

.filter-section select {
  flex: 1;
  min-width: 150px;
  padding: 10px 15px;
  border: 1px solid var(--gray-light);
  border-radius: 8px;
  background: var(--light-bg);
  font-size: 14px;
}

.stats-section {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  background: var(--light-bg);
  padding: 20px;
  border-radius: 12px;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
}

.stat-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 15px;
  border-radius: 25px;
  background: var(--white);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  min-width: 120px;
  justify-content: center;
}

.stat-label {
  font-weight: bold;
  color: var(--text-light);
  font-size: 14px;
}

.stat-value {
  font-weight: bold;
  font-size: 16px;
}

.stat-value.present {
  color: var(--success-color);
}

.stat-value.absent {
  color: var(--danger-color);
}

.attendance-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
  padding: 15px;
  background: var(--white);
  border-radius: 12px;
  box-shadow: var(--shadow);
}

.students-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.student-item {
  background: var(--white);
  border-radius: 12px;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.student-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.student-item.present {
  border-right: 4px solid var(--success-color);
}

.student-item.absent {
  border-right: 4px solid var(--danger-color);
}

.student-info {
  flex: 1;
}

.student-name {
  font-weight: bold;
  display: block;
  margin-bottom: 5px;
  font-size: 16px;
}

.student-id, .student-grade, .student-group {
  font-size: 13px;
  color: var(--text-light);
  margin-right: 8px;
  display: inline-block;
}

.attendance-actions .btn-small {
  padding: 8px 15px;
  font-size: 14px;
  border-radius: 8px;
  font-weight: 600;
}

.attendance-actions .btn-small.active {
  transform: scale(1.05);
  box-shadow: 0 0 0 2px currentColor;
}

.no-whatsapp-section {
  margin-top: 30px;
  padding: 20px;
  border-top: 2px solid var(--gray-light);
  background: var(--white);
  border-radius: 12px;
  box-shadow: var(--shadow);
}

.no-whatsapp-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.student-item.no-whatsapp {
  background: #fff8e1;
  border-right: 4px solid var(--warning-color);
}

@media (max-width: 768px) {
  .students-list {
    grid-template-columns: 1fr;
  }
  
  .student-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }
  
  .attendance-actions {
    width: 100%;
    justify-content: flex-end;
  }
  
  .filter-section {
    flex-direction: column;
    align-items: stretch;
  }
  
  .stats-section {
    flex-direction: column;
    align-items: center;
  }
  
  .stat-item {
    width: 100%;
    justify-content: space-between;
  }
}
/* Ø£Ù†Ù…Ø§Ø· Ø¨Ø·Ø§Ù‚Ø§Øª QR code */
.qr-cards-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.qr-card {
  background: var(--white);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 20px;
  text-align: center;
  page-break-inside: avoid;
}

.qr-card-header {
  margin-bottom: 15px;
}

.qr-card-header h4 {
  margin: 0 0 5px 0;
  color: var(--text-dark);
  font-size: 18px;
}

.student-info {
  font-size: 14px;
  color: var(--text-light);
}

.qr-code-container {
  margin: 15px 0;
  display: flex;
  justify-content: center;
}

.qr-card-footer {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid var(--gray-light);
}

.teacher-name {
  font-weight: bold;
  color: var(--primary-color);
}

.teacher-subject {
  font-size: 12px;
  color: var(--text-light);
}

.qr-filter {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  align-items: center;
}

/* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
@media print {
  .qr-card {
    border: 1px solid #000;
    page-break-inside: avoid;
  }
}
  </style>
</head>
<body>
<!-- Modal Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù…Ù„ -->
<div id="imageModal" class="modal image-modal">
  <span class="close-image" onclick="closeImageModal()">&times;</span>
  <div class="modal-content">
    <img class="image-modal-content" id="expandedImage">
  </div>
</div>

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <h2><i class="fas fa-lock"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input type="password" id="loginPassword" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button class="btn btn-success" onclick="checkLogin()"><i class="fas fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

<!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
<div class="sidebar-toggle" onclick="toggleSidebar()">
  <i class="fas fa-bars"></i>
</div>

<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2 class="sidebar-title"><i class="fas fa-user-graduate"></i> Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
    <button class="btn btn-danger" onclick="toggleSidebar()">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <ul class="sidebar-menu">
    <!-- ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
     <!-- Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <li><a href="#" onclick="showAllStudents()"><i class="fas fa-eye"></i> Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</a></li>
   <li><a href="#" onclick="showQRCodesModal()"><i class="fas fa-qrcode"></i> Ø¨Ø·Ø§Ù‚Ø§Øª QR Code</a></li>
    <li><a href="#" onclick="showAddModal()"><i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</a></li>
    <li><a href="#" onclick="showDeleteModal(null)"><i class="fas fa-user-minus"></i> Ø­Ø°Ù Ø·Ø§Ù„Ø¨</a></li>
    <li><a href="#" onclick="showAllStudents()"><i class="fas fa-users"></i> Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</a></li>
    <li><a href="#" onclick="showReports('fees')"><i class="fas fa-money-bill-wave"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</a></li>
    <li><a href="#" onclick="showReports('attendance')"><i class="fas fa-calendar-check"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ±</a></li>
    <li><a href="#" onclick="showReports('weekly')"><i class="fas fa-file-alt"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</a></li>
    <li><a href="#" onclick="showGradeModal()"><i class="fas fa-filter"></i> ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØµÙ</a></li>
    <li><a href="#" onclick="showGroupModal()"><i class="fas fa-filter"></i> ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</a></li>
    <li><a href="#" onclick="showCreateGroupModal()"><i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</a></li>
    <li><a href="#" onclick="showTrash()"><i class="fas fa-trash"></i> Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª</a></li>
    <li><a href="#" onclick="exportData('json')"><i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</a></li>
    <li><a href="#" onclick="saveToGitHub()"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</a></li>
  </ul>
</div>

<!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div class="container">
  <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
  <div class="header">
    <h1><i class="fas fa-user-graduate"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
    <div class="header-actions">
      <div class="grade-select">
        <button class="btn" onclick="showGradeModal()"><i class="fas fa-filter"></i> ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØµÙ</button>
        <button class="btn" onclick="showGroupModal()"><i class="fas fa-filter"></i> ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
        <button class="btn btn-success" onclick="showCreateGroupModal()"><i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
      </div>
      <button class="btn theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
      </button>
    </div>
  </div>

  <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ØµÙØ­Ø© -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('students')">
      <i class="fas fa-users"></i> Ø§Ù„Ø·Ù„Ø§Ø¨
    </div>
    <div class="tab" onclick="switchTab('posts')">
      <i class="fas fa-newspaper"></i> Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
    </div>
    <div class="tab" onclick="switchTab('reports')">
      <i class="fas fa-chart-bar"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    </div>
  </div>

  <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
  <div id="students-tab" class="tab-content active">
    <div class="file-info">
      <div><i class="fas fa-file-alt"></i> Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentDataFile">students.json</span></div>
      <div><i class="fas fa-users"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: <span id="totalStudentsInFile">0</span></div>
    </div>

    <div class="control-panel">
      <input type="text" id="token" placeholder="ğŸ”‘ GitHub Token">
      <input type="text" id="searchId" placeholder="ğŸ” ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨">
      <button class="btn" onclick="searchStudent()"><i class="fas fa-search"></i> Ø¨Ø­Ø«</button>
      <div class="btn-group">
        <button class="btn btn-success" onclick="showAddModal()"><i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ©</button>
        <button class="btn btn-secondary" onclick="hideAllStudents()"><i class="fas fa-eye-slash"></i> Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙ„</button>
        <button class="btn btn-secondary" onclick="showAllStudents()"><i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
        <button class="btn btn-warning" onclick="saveToGitHub()"><i class="fas fa-save"></i> Ø­ÙØ¸</button>
      </div>
    </div>

    <div id="studentsCount" style="background: var(--white); padding: 15px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span><i class="fas fa-users"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ÙŠÙ†: <span id="studentsCountNumber">0</span></span>
        <span><i class="fas fa-calendar-alt"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…: <span id="currentDate"></span></span>
      </div>
    </div>
    
    <div id="studentsCards"></div>
  </div>

  <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª -->
  <div id="posts-tab" class="tab-content">
    <div class="posts-container">
      <div class="posts-header">
        <h2><i class="fas fa-newspaper"></i> Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h2>
        <button class="btn btn-success" onclick="showPostModal()">
          <i class="fas fa-plus"></i> Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯
        </button>
      </div>

      <div id="postsList"></div>
    </div>
  </div>

  <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
  <div id="reports-tab" class="tab-content">
    <div class="posts-container">
      <div class="posts-header">
        <h2><i class="fas fa-chart-bar"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
      </div>

      <div class="report-type-selector">
        <button class="btn report-type-btn" onclick="showReports('fees')">
          <i class="fas fa-money-bill-wave"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
        </button>
        <button class="btn report-type-btn" onclick="showReports('attendance')">
          <i class="fas fa-calendar-check"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ±
        </button>
        <button class="btn report-type-btn" onclick="showReports('stats')">
          <i class="fas fa-chart-pie"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        </button>
        <button class="btn report-type-btn" onclick="showReports('weekly')">
          <i class="fas fa-file-alt"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
        </button>
      </div>

      <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
      <div id="statsReport" class="report-section">
        <div class="stats-cards">
          <div class="stat-card total">
            <h3><i class="fas fa-users"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
            <div class="value" id="totalStudentsCount">0</div>
            <div class="description">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
          </div>
          
          <div class="stat-card present">
            <h3><i class="fas fa-user-check"></i> Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</h3>
            <div class="value" id="todayPresentCount">0</div>
            <div class="description">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</div>
          </div>
          
          <div class="stat-card absent">
            <h3><i class="fas fa-user-times"></i> Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</h3>
            <div class="value" id="todayAbsentCount">0</div>
            <div class="description">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</div>
          </div>
          
          <div class="stat-card paid">
            <h3><i class="fas fa-check-circle"></i> Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¯Ø¯Ø©</h3>
            <div class="value" id="paidFeesCount">0</div>
            <div class="description">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ø³Ø¯Ø¯ÙˆØ§ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
          </div>
          
          <div class="stat-card unpaid">
            <h3><i class="fas fa-exclamation-circle"></i> Ù…ØµØ±ÙˆÙØ§Øª ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø©</h3>
            <div class="value" id="unpaidFeesCount">0</div>
            <div class="description">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ÙŠØ³Ø¯Ø¯ÙˆØ§ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
          </div>
        </div>
      </div>

      <!-- ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª -->
      <div id="feesReport" class="report-section">
        <div class="report-header">
          <h3><i class="fas fa-money-bill-wave"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
          <button class="btn btn-success excel-btn" onclick="exportToExcel()">
            <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
          </button>
        </div>
        
        <div class="report-filter">
          <select id="feesGradeFilter" style="flex: 1;">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
          </select>
          <select id="feesGroupFilter" style="flex: 1;">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>
          </select>
          <select id="feesMonthFilter" style="flex: 1;">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ù‡Ø±</option>
          </select>
          <select id="feesStatusFilter" style="flex: 1;">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="paid">Ù…Ø³Ø¯Ø¯Ø©</option>
            <option value="unpaid">ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø©</option>
          </select>
          <button class="btn" onclick="filterFeesReport()">
            <i class="fas fa-filter"></i> ØªØµÙÙŠØ©
          </button>
        </div>
        
        <div class="table-responsive">
          <table class="report-table" id="feesReportTable">
            <thead>
              <tr>
                <th>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„ØµÙ</th>
                <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
                <th>Ø£ØºØ³Ø·Ø³</th>
                <th>Ø³Ø¨ØªÙ…Ø¨Ø±</th>
                <th>Ø£ÙƒØªÙˆØ¨Ø±</th>
                <th>Ù†ÙˆÙÙ…Ø¨Ø±</th>
                <th>Ø¯ÙŠØ³Ù…Ø¨Ø±</th>
                <th>ÙŠÙ†Ø§ÙŠØ±</th>
                <th>ÙØ¨Ø±Ø§ÙŠØ±</th>
                <th>Ù…Ø§Ø±Ø³</th>
                <th>Ø£Ø¨Ø±ÙŠÙ„</th>
              </tr>
            </thead>
            <tbody id="feesReportBody"></tbody>
          </table>
        </div>
      </div>

      <!-- ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± -->
      <div id="attendanceReport" class="report-section">
        <div class="report-header">
          <h3><i class="fas fa-calendar-check"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h3>
          <button class="btn btn-success excel-btn" onclick="exportAttendanceToExcel()">
            <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
          </button>
        </div>
        
        <div class="report-filter">
          <select id="attendanceGradeFilter" style="flex: 1;">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
          </select>
          <select id="attendanceGroupFilter" style="flex: 1;">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>
          </select>
          <select id="attendanceDayFilter" style="flex: 1;">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠØ§Ù…</option>
          </select>
          <select id="attendanceStatusFilter" style="flex: 1;">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="Ø­Ø§Ø¶Ø±">Ø­Ø§Ø¶Ø±</option>
            <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨</option>
          </select>
          <button class="btn" onclick="filterAttendanceReport()">
            <i class="fas fa-filter"></i> ØªØµÙÙŠØ©
          </button>
        </div>
        
        <div class="table-responsive">
          <table class="report-table" id="attendanceReportTable">
            <thead>
              <tr>
                <th>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„ØµÙ</th>
                <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
                <th>Ø§Ù„Ø³Ø¨Øª</th>
                <th>Ø§Ù„Ø£Ø­Ø¯</th>
                <th>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</th>
                <th>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</th>
                <th>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</th>
                <th>Ø§Ù„Ø®Ù…ÙŠØ³</th>
                <th>Ø§Ù„Ø¬Ù…Ø¹Ø©</th>
              </tr>
            </thead>
            <tbody id="attendanceReportBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© -->
      <div id="weeklyReport" class="report-section">
        <div class="report-header">
          <h3><i class="fas fa-file-alt"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h3>
        </div>

        <div class="weekly-report">
          <div class="report-form">
            <div class="report-form-group">
              <label for="reportStudentSelect"><i class="fas fa-user-graduate"></i> Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨</label>
              <select id="reportStudentSelect" class="form-control">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨</option>
              </select>
            </div>
            
            <div class="report-form-group">
              <label for="reportDate"><i class="fas fa-calendar"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
              <input type="date" id="reportDate" class="form-control">
            </div>
            <div class="report-form-group">
               <label>Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…:</label>
    <select id="daySelect">
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ… --</option>
        <option value="Ø§Ù„Ø³Ø¨Øª">Ø§Ù„Ø³Ø¨Øª</option>
        <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
        <option value="Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†">Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</option>
        <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
        <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
        <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
        <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
    </select>
            </div>

            <div class="report-form-group">
              <label for="reportAttendance"><i class="fas fa-calendar-check"></i> Ø§Ù„Ø­Ø¶ÙˆØ±</label>
              <select id="reportAttendance" class="form-control">
                <option value="Ø­Ø§Ø¶Ø±">Ø­Ø§Ø¶Ø±</option>
                <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨</option>
              </select>
            </div>
            
            <div class="report-form-group">
              <label for="reportHomework"><i class="fas fa-book"></i> Ø§Ù„ÙˆØ§Ø¬Ø¨</label>
              <select id="reportHomework" class="form-control">
                <option value="ØªÙ…">ØªÙ…</option>
                <option value="Ù„Ù… ÙŠØªÙ…">Ù„Ù… ÙŠØªÙ…</option>
              </select>
            </div>
            
            <div class="report-form-group">
              <label for="reportWords"><i class="fas fa-language"></i> Ø§Ù„ÙƒÙ„Ù…Ø§Øª</label>
              <select id="reportWords" class="form-control">
                <option value="ØªÙ…">ØªÙ…</option>
                <option value="Ù„Ù… ÙŠØªÙ…">Ù„Ù… ÙŠØªÙ…</option>
              </select>
            </div>
            
            <div class="report-form-group">
              <label for="reportTestScore"><i class="fas fa-graduation-cap"></i> Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</label>
              <input type="number" id="reportTestScore" class="form-control" min="0" max="15" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø© Ù…Ù† 15">
            </div>
            
            <div class="report-form-group" style="grid-column: span 2;">
              <label for="reportNotes"><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
              <textarea id="reportNotes" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
            </div>
          </div>

          <div class="report-preview">
            <h4><i class="fas fa-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h4>
            <div class="report-template" id="reportPreview">
              <p class="report-date">Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="previewDate"></span></p>
              <h3>ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø¹Ù† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
              
              <div class="report-item">
                <span class="report-item-label">Ø§Ù„Ø­Ø¶ÙˆØ±:</span>
                <span id="previewAttendance">Ø­Ø§Ø¶Ø±</span>
              </div>
              
              <div class="report-item">
                <span class="report-item-label">Ø§Ù„ÙˆØ§Ø¬Ø¨:</span>
                <span id="previewHomework">ØªÙ…</span>
              </div>
              
              <div class="report-item">
                <span class="report-item-label">Ø§Ù„ÙƒÙ„Ù…Ø§Øª:</span>
                <span id="previewWords">ØªÙ…</span>
              </div>
             
              <div class="report-item">
                <span class="report-item-label">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ:</span>
                <span id="previewTestScore">0/15</span>
              </div>
              
              <div class="report-item" style="grid-column: span 2;">
                <span class="report-item-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span>
                <span id="previewNotes">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>
              </div>
              
              <div class="report-footer">
                <p>Ù…Ø¹ ØªØ­ÙŠØ§ØªÙŠØŒ</p>
                <p>Ø£/ Ø¹Ù„ÙŠ Ø®Ù„ÙŠÙÙ‡</p>
                <p>Ù…Ø¯Ø±Ø³ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</p>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn" onclick="clearReportForm()">
              <i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            </button>
            <button class="btn btn-success" onclick="saveWeeklyReport()">
              <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            </button>
            <button class="btn btn-primary" onclick="sendReportToWhatsApp()">
              <i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
            </button>
          </div>
        </div>

        <div class="weekly-reports-list" id="weeklyReportsList" style="margin-top: 30px;">
          <h4><i class="fas fa-list"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h4>
          <div id="reportsListContainer"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨ -->
<div id="studentModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle"><i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label for="studentId"><i class="fas fa-id-card"></i> ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</label>
        <input type="text" id="studentId" placeholder="Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" disabled>
      </div>
      
      <div class="form-group">
        <label for="studentName"><i class="fas fa-user"></i> Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
        <input type="text" id="studentName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" required>
      </div>
      
      <div class="form-group">
        <label for="studentGrade"><i class="fas fa-graduation-cap"></i> Ø§Ù„ØµÙ</label>
        <select id="studentGrade" required>
          <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
         <!-- Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© -->
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>

<!-- Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ© -->
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>

<!-- Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© -->
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>

        </select>
      </div>
      
      <div class="form-group">
        <label for="studentGroup"><i class="fas fa-users"></i> Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
        <select id="studentGroup">
          <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</option>
          <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ù…Ù† Ø®Ù„Ø§Ù„ JavaScript -->
          <option value="_new_group_">+ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="schoolName"><i class="fas fa-school"></i> Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
        <input type="text" id="schoolName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
      </div>
      
      <div class="form-group">
        <label for="studentPhone"><i class="fas fa-phone"></i> Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ù„Ø£Ø¨)</label>
        <input type="tel" id="studentPhone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
      </div>
      
      <div class="form-group">
        <label for="motherPhone"><i class="fas fa-phone"></i> Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ù„Ø£Ù…)</label>
        <input type="tel" id="motherPhone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
      </div>
      
      <div class="form-group">
        <label for="studentday"><i class="fas fa-calendar-day"></i> Ø§Ù„ÙŠÙˆÙ…</label>
        <select id="studentday">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…</option>
          <option value="Ø§Ù„Ø³Ø¨Øª">Ø§Ù„Ø³Ø¨Øª</option>
          <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
          <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
          <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
          <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
          <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
          <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
        </select>
      </div>
      
      <div class="form-group">
        <label><i class="fas fa-image"></i> ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</label>
        <div class="image-upload-container">
          <div class="image-preview-wrapper">
            <img id="studentImagePreview" class="image-preview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©" onclick="expandImage(this)">
            <div class="image-actions" id="imageActions">
              <button type="button" class="btn btn-small btn-danger" onclick="removeImage()">
                <i class="fas fa-trash"></i> Ø­Ø°Ù
              </button>
              <button type="button" class="btn btn-small btn-success" onclick="document.getElementById('studentImage').click()">
                <i class="fas fa-sync"></i> ØªØºÙŠÙŠØ±
              </button>
            </div>
          </div>
          <button type="button" class="btn upload-btn">
            <i class="fas fa-upload"></i> Ø§Ø®ØªØ± ØµÙˆØ±Ø©
            <input type="file" id="studentImage" accept="image/*" onchange="previewStudentImage()" style="display: none;">
          </button>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="btn" onclick="closeModal()">
        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
      </button>
      <button type="button" class="btn btn-success" id="saveStudentBtn">
        <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨
      </button>
    </div>
  </div>
</div>

<!-- Modal Ø­Ø°Ù Ø·Ø§Ù„Ø¨ -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title"><i class="fas fa-trash-alt"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    
    <div class="modal-body">
      <div style="background: #fde8e8; color: var(--danger-color); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>ØªØ­Ø°ÙŠØ±:</strong> Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!
      </div>
      
      <div id="deleteStudentInfo" style="display: none;">
        <div class="student-card" style="background: var(--light-bg); padding: 15px; border-radius: 8px;">
          <div class="student-header">
            <div>
              <div class="student-name" id="deleteStudentName"></div>
              <div class="student-id" id="deleteStudentId"></div>
            </div>
            <div class="student-grade" id="deleteStudentGrade"></div>
          </div>
        </div>
      </div>
      
      <div id="deleteStudentSelectContainer" style="margin-top: 15px;">
        <select id="deleteStudentSelect" style="width: 100%;">
          <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ø­Ø°Ù</option>
        </select>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">
        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
      </button>
      <button class="btn btn-danger" onclick="confirmDelete()">
        <i class="fas fa-trash"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
      </button>
    </div>
  </div>
</div>

<!-- Modal Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
<div id="notesModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title"><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <textarea id="notesContent" rows="8" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨..." 
                  style="width: 100%; border-radius: 8px; padding: 15px; border: 1px solid var(--gray-light);"></textarea>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">
        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
      </button>
      <button class="btn btn-success" onclick="saveNotes()">
        <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
      </button>
    </div>
  </div>
</div>

<!-- Modal Ù„Ø¹Ø±Ø¶ QR codes -->
<div id="qrCodesModal" class="modal">
  <div class="modal-content" style="max-width: 1200px;">
    <div class="modal-header">
      <h3 class="modal-title"><i class="fas fa-qrcode"></i> Ø¨Ø·Ø§Ù‚Ø§Øª QR Code Ù„Ù„Ø·Ù„Ø§Ø¨</h3>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    
    <div class="modal-body">
      <div class="qr-filter">
        <select id="qrGradeFilter" class="form-control">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
<!-- Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© -->
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>

<!-- Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ© -->
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>

<!-- Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© -->
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
<option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>

        </select>
        
        <select id="qrGroupFilter" class="form-control">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>
        </select>
        
        <button class="btn" onclick="filterQRCodes()">
          <i class="fas fa-filter"></i> ØªØµÙÙŠØ©
        </button>
        
        <button class="btn btn-success" onclick="printQRCodes()">
          <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
        </button>
      </div>
      
      <div class="qr-cards-container" id="qrCardsContainer"></div>
    </div>
  </div>
</div>

<!-- Modal Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª -->
<div id="postModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="postModalTitle"><i class="fas fa-plus"></i> Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</h3>
      <span class="close" onclick="closePostModal()">&times;</span>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label for="editPostTitle"><i class="fas fa-heading"></i> Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±</label>
        <input type="text" id="editPostTitle" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±">
      </div>
      
      <div class="form-group">
        <label for="editPostContent"><i class="fas fa-align-left"></i> Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</label>
        <textarea id="editPostContent" rows="6" placeholder="Ø§ÙƒØªØ¨ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù‡Ù†Ø§..."></textarea>
      </div>
      
      <div class="form-group">
        <label><i class="fas fa-image"></i> ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <div class="image-upload-container">
          <div class="image-preview-wrapper">
            <img id="postImagePreview" class="image-preview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©" onclick="expandImage(this)">
            <div class="image-actions" id="postImageActions">
              <button class="btn btn-small btn-danger" onclick="removePostImage()">
                <i class="fas fa-trash"></i> Ø­Ø°Ù
              </button>
              <button class="btn btn-small btn-success" onclick="document.getElementById('postImageInput').click()">
                <i class="fas fa-sync"></i> ØªØºÙŠÙŠØ±
              </button>
            </div>
          </div>
          <button class="btn upload-btn">
            <i class="fas fa-upload"></i> Ø§Ø®ØªØ± ØµÙˆØ±Ø©
            <input type="file" id="postImageInput" accept="image/*" onchange="previewPostImage()">
          </button>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn" onclick="closePostModal()">
        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
      </button>
      <button class="btn btn-success" id="savePostBtn">
        <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
      </button>
    </div>
  </div>
</div>

<!-- Modal ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ -->
<div id="studentDetailModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title"><i class="fas fa-user"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div class="modal-body" id="studentDetailContent"></div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">
        <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
      </button>
    </div>
  </div>
</div>

<!-- Modal Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª -->
<div id="trashModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title"><i class="fas fa-trash"></i> Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª</h3>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div id="trashContent"></div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">
        <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
      </button>
    </div>
  </div>
</div>

<!-- Popup for Attendance -->
<div id="attendancePopup" class="popup-overlay" style="display: none;">
  <div class="popup-content">
    <div class="popup-header">
      <h3 class="popup-title"><i class="fas fa-calendar-check"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h3>
      <span class="popup-close" onclick="closeAttendancePopup()">&times;</span>
    </div>
    <div class="popup-body" id="attendancePopupBody">
      <!-- Content will be added dynamically -->
    </div>
    <div class="popup-footer">
      <button class="btn" onclick="closeAttendancePopup()">
        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
      </button>
      <button class="btn btn-success" onclick="saveAttendance()">
        <i class="fas fa-save"></i> Ø­ÙØ¸
      </button>
    </div>
  </div>
</div>

<!-- Popup for Fees -->
<div id="feesPopup" class="popup-overlay" style="display: none;">
  <div class="popup-content">
    <div class="popup-header">
      <h3 class="popup-title"><i class="fas fa-money-bill-wave"></i> ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
      <span class="popup-close" onclick="closeFeesPopup()">&times;</span>
    </div>
    <div class="popup-body" id="feesPopupBody">
      <!-- Content will be added dynamically -->
    </div>
    <div class="popup-footer">
      <button class="btn" onclick="closeFeesPopup()">
        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
      </button>
      <button class="btn btn-success" onclick="saveFees()">
        <i class="fas fa-save"></i> Ø­ÙØ¸
      </button>
    </div>
  </div>
</div>


<script>
// Initialize jsPDF
const { jsPDF } = window.jspdf;

let students = {};
let posts = {};
let trash = {};
let weeklyReports = {};
let groups = [" ", " ", " ", " ", " "]; // Ø¨Ø¯Ø§ÙŠØ© Ø¨Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
let sha = "";
const owner = "Devolepor";
const repo = "data_more";
const path = "students.json";
const postsPath = "posts.json";
const trashPath = "trash.json";
const reportsPath = "reports.json";
const groupsPath = "groups.json"; // Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
const branch = "main";
const PASSWORD = "admin123";
const MAX_FILE_SIZE = Number.MAX_SAFE_INTEGER;
let currentStudentId = null;
let currentPostId = null;
let deleteStudentId = null;
let isLoading = false;
let originalButtonText = "";
let postImageFile = null;
let studentImageFile = null;
let allStudentsData = {};
let currentDataFile = "students.json";
let currentPopupStudentId = null;

const grades = [
  // Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©
  "Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
  "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
  "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
  "Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
  "Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
  "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",

  // Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©
  "Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ",
  "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ",
  "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ",

  // Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©
  "Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ",
  "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ",
  "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ"
];


const days = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©"];

const weekDays = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©"];
const months = ["Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±", "ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„"];

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨
function sendWhatsAppNotification(phone, message) {
  if (!phone) return;
  
  const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
  window.open(whatsappUrl, '_blank');
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
function sendNewStudentNotification(studentId, studentData) {
  const message = `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰\n\n`
               + `Ø§Ù„Ø§Ø³Ù…: ${studentData.name}\n`
               + `Ø§Ù„ÙƒÙˆØ¯: ${studentId}\n`
               + `Ø§Ù„ØµÙ: ${studentData.main}\n`
               + `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${studentData.group || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`
               + `Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${studentData.school || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`
               + `Ø§Ù„ÙŠÙˆÙ…: ${studentData.day || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n\n`
               + `Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ³Ø¬ÙŠÙ„Ùƒ Ù…Ø¹Ù†Ø§!`;
  
  if (studentData.phone) {
    sendWhatsAppNotification(studentData.phone, message);
  }
  
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø£Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù…Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯
  if (studentData.motherPhone) {
    sendWhatsAppNotification(studentData.motherPhone, message);
  }
}

// ØªØ­Ø³ÙŠÙ† Ø±Ø³Ø§Ù„Ø© Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø­Ø¶ÙˆØ±
function sendAttendanceNotification(studentId, studentData, day, status) {
  const date = new Date().toLocaleDateString('ar-EG');
  const time = new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});
  
  const message = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± - ${day}\n\n`
               + `Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentData.name}\n`
               + `Ø§Ù„ØµÙ: ${studentData.main}\n`
               + `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${studentData.group || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`
               + `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}\n`
               + `Ø§Ù„ÙˆÙ‚Øª: ${time}\n`
               + `Ø§Ù„Ø­Ø§Ù„Ø©: ${status === 'Ø­Ø§Ø¶Ø±' ? 'Ø­Ø§Ø¶Ø± âœ…' : 'ØºØ§Ø¦Ø¨ âŒ'}\n\n`
               + `Ù…Ø¹ ØªØ­ÙŠØ§ØªÙŠØŒ\nØ£/  Ø¹Ù„ÙŠ Ø®Ù„ÙŠÙÙ‡\nÙ…Ø¯Ø±Ø³ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠÙ‡`;
  
  if (studentData.phone) {
    sendWhatsAppNotification(studentData.phone, message);
  }
  
  if (studentData.motherPhone) {
    sendWhatsAppNotification(studentData.motherPhone, message);
  }
}
// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
function sendFeesNotification(studentId, studentData, month, isPaid) {
  const message = `ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ğŸ’°\n\n`
               + `Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentData.name}\n`
               + `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${studentData.group || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`
               + `Ø§Ù„Ø´Ù‡Ø±: ${month}\n`
               + `Ø§Ù„Ø­Ø§Ù„Ø©: ${isPaid ? 'ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯ âœ…' : 'ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø© âŒ'}\n\n`
               + `Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…ØªØ§Ø¨Ø¹ØªÙƒÙ…`;
  
  if (studentData.phone) {
    sendWhatsAppNotification(studentData.phone, message);
  }
  
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø£Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù…Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯
  if (studentData.motherPhone) {
    sendWhatsAppNotification(studentData.motherPhone, message);
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©
function sendNotesNotification(studentId, studentData, notes) {
  const message = `Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø·Ø§Ù„Ø¨ ğŸ“\n\n`
               + `Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentData.name}\n`
               + `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${studentData.group || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`
               + `Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©: ${notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}\n\n`
               + `Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…ØªØ§Ø¨Ø¹ØªÙƒÙ…`;
  
  if (studentData.phone) {
    sendWhatsAppNotification(studentData.phone, message);
  }
  
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø£Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù…Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯
  if (studentData.motherPhone) {
    sendWhatsAppNotification(studentData.motherPhone, message);
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
function sendUpdateNotification(studentId, studentData, updatedFields) {
  let message = `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ğŸ”„\n\n`
              + `Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentData.name}\n`
              + `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${studentData.group || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`
              + `Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª:\n`;
  
  for (const [field, value] of Object.entries(updatedFields)) {
    message += `${field}: ${value}\n`;
  }
  
  message += `\nØ´ÙƒØ±Ø§Ù‹ Ù„Ù…ØªØ§Ø¨Ø¹ØªÙƒÙ…`;
  
  if (studentData.phone) {
    sendWhatsAppNotification(studentData.phone, message);
  }
  
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø£Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù…Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯
  if (studentData.motherPhone) {
    sendWhatsAppNotification(studentData.motherPhone, message);
  }
}

function sendWeeklyReportNotification(studentId, studentData, reportData) {
  const selectedDay = document.getElementById("daySelect").value;

  const message = `ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø¹Ù† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨ ğŸ“Š\n\n`
               + `Ø§Ù„ÙŠÙˆÙ…: ${selectedDay || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}\n`
               + `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${reportData.date}\n`
               + `Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentData.name}\n`
               + `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${studentData.group || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n\n`
               + `Ø§Ù„Ø­Ø¶ÙˆØ±: ${reportData.attendance}\n`
               + `Ø§Ù„ÙˆØ§Ø¬Ø¨: ${reportData.homework}\n`
               + `Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ${reportData.words}\n`
               + `Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ: ${reportData.testScore}/15\n\n`
               + `Ù…Ù„Ø§Ø­Ø¸Ø§Øª:\n${reportData.notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}\n\n`
               + `Ù…Ø¹ ØªØ­ÙŠØ§ØªÙŠØŒ\nØ£/  Ø¹Ù„ÙŠ Ø®Ù„ÙŠÙÙ‡\nÙ…Ø¯Ø±Ø³ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©`;

  if (studentData.phone) {
    sendWhatsAppNotification(studentData.phone, message);
  }
  
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø£Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù…Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯
  if (studentData.motherPhone) {
    sendWhatsAppNotification(studentData.motherPhone, message);
  }
}

// Check for saved theme preference
if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark-mode");
  document.getElementById("themeToggle").innerHTML = '<i class="fas fa-sun"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ';
}

if (localStorage.getItem("gh_token")) {
  document.getElementById("token").value = localStorage.getItem("gh_token");
}

// Theme toggle functionality
document.getElementById("themeToggle").addEventListener("click", function() {
  document.body.classList.toggle("dark-mode");
  if (document.body.classList.contains("dark-mode")) {
    localStorage.setItem("theme", "dark");
    this.innerHTML = '<i class="fas fa-sun"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ';
  } else {
    localStorage.setItem("theme", "light");
    this.innerHTML = '<i class="fas fa-moon"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ';
  }
});

// Toggle sidebar
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

// Ø¯Ø§Ù„Ø© Ù„ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø·Ø§Ù„Ø¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…
function generateStudentId() {
  let id;
  do {
    id = Math.floor(100000 + Math.random() * 900000).toString();
  } while (allStudentsData[id]);
  return id;
}

function checkLogin() {
  const pass = document.getElementById("loginPassword").value;
  if (pass === PASSWORD) {
    localStorage.setItem("isLoggedIn", "true");
    document.getElementById("loginScreen").style.display = "none";
    loadAllStudentsData();
    loadPosts();
    loadTrash();
    loadWeeklyReports();
    loadGroups(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    fillGradeSelects();
    fillGroupSelects();
    const today = new Date();
    document.getElementById('currentDate').textContent = today.toLocaleDateString('ar-EG');
  } else {
    Swal.fire({
      title: 'Ø®Ø·Ø£!',
      text: 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!',
      icon: 'error',
      confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
    });
  }
}

// ØªØ¹Ø¨Ø¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØµÙÙˆÙ ÙÙŠ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
function fillGradeSelects() {
  const gradeSelects = [
    document.getElementById('studentGrade'),
    document.getElementById('gradeSelect'),
    document.getElementById('feesGradeFilter'),
    document.getElementById('attendanceGradeFilter'),
    document.getElementById('reportStudentSelect')
  ];
  
  gradeSelects.forEach(select => {
    if (select) {
      select.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>';
      grades.forEach(grade => {
        select.innerHTML += `<option value="${grade}">${grade}</option>`;
      });
    }
  });
  
  const monthSelect = document.getElementById('feesMonthFilter');
  if (monthSelect) {
    monthSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ù‡Ø±</option>';
    months.forEach(month => {
      monthSelect.innerHTML += `<option value="${month}">${month}</option>`;
    });
  }
  
  const daySelect = document.getElementById('attendanceDayFilter');
  if (daySelect) {
    daySelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠØ§Ù…</option>';
    weekDays.forEach(day => {
      daySelect.innerHTML += `<option value="${day}">${day}</option>`;
    });
  }
  
  const studentSelect = document.getElementById('reportStudentSelect');
  if (studentSelect) {
    studentSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨</option>';
    for (let id in students) {
      const student = students[id];
      studentSelect.innerHTML += `<option value="${id}">${id} - ${student.name} (${student.main})</option>`;
    }
  }
}

// ØªØ¹Ø¨Ø¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙÙŠ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
function fillGroupSelects() {
  const groupSelects = [
    document.getElementById('studentGroup'),
    document.getElementById('groupSelect'),
    document.getElementById('feesGroupFilter'),
    document.getElementById('attendanceGroupFilter')
  ];
  
  groupSelects.forEach(select => {
    if (select) {
      select.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</option>';
      groups.forEach(group => {
        select.innerHTML += `<option value="${group}">${group}</option>`;
      });
      // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
      select.innerHTML += `<option value="_new_group_">+ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</option>`;
    }
  });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
async function loadAllStudentsData() {
  try {
    showLoading(true);
    allStudentsData = {};
    students = {};
    
    await loadStudentsFile("students.json");
    
    let fileNumber = 1;
    let moreFilesExist = true;
    
    while (moreFilesExist) {
      try {
        const fileName = `students_${fileNumber}.json`;
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${fileName}`);
        
        if (res.ok) {
          await loadStudentsFile(fileName);
          fileNumber++;
        } else {
          moreFilesExist = false;
        }
      } catch (error) {
        moreFilesExist = false;
      }
    }
    
    determineCurrentFile();
    renderStudentCards();
    updateStats();
    fillGradeSelects();
    fillGroupSelects();
  } catch (error) {
    console.error("Error loading students data:", error);
    showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨");
  } finally {
    showLoading(false);
  }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø·Ù„Ø§Ø¨ Ù…Ø¹ÙŠÙ†
async function loadStudentsFile(fileName) {
  try {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${fileName}`);
    if (!res.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø·Ù„Ø§Ø¨');
    
    const data = await res.json();
    const decodedContent = decodeURIComponent(escape(atob(data.content)));
    const fileData = JSON.parse(decodedContent);
    
    Object.assign(allStudentsData, fileData);
    
    if (fileName === currentDataFile) {
      students = fileData;
      sha = data.sha;
    }
    
    return true;
  } catch (error) {
    console.error(`Error loading file ${fileName}:`, error);
    return false;
  }
}

function searchStudent() {
    const searchTerm = document.getElementById('searchId').value.trim();
    if (!searchTerm) {
        Swal.fire('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„Ø¨Ø­Ø«', 'error');
        return;
    }
    
    let foundStudents = [];
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¨ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ù…Ø·Ø§Ø¨Ù‚Ø© ÙƒØ§Ù…Ù„Ø©)
    if (students[searchTerm]) {
        foundStudents.push({id: searchTerm, student: students[searchTerm]});
    }
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¬Ø²Ø¦ÙŠØ©)
    for (let id in students) {
        const s = students[id];
        if (s.name && s.name.includes(searchTerm)) {
            foundStudents.push({id: id, student: s});
        } else if ((s.phone && s.phone.includes(searchTerm)) || 
                  (s.motherPhone && s.motherPhone.includes(searchTerm))) {
            foundStudents.push({id: id, student: s});
        }
    }
    
    if (foundStudents.length === 1) {
        showStudentDetails(foundStudents[0].id);
    } else if (foundStudents.length > 1) {
        showSearchResults(foundStudents);
    } else {
        Swal.fire('Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ø§Ù„Ø¨ Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}

function showSearchResults(studentsList) {
    let html = '<div class="search-results-container">';
    html += '<h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:</h3>';
    html += '<div class="search-results-list">';
    
    studentsList.forEach(item => {
        html += `
            <div class="search-result-item" onclick="showStudentDetails('${item.id}')">
                <div class="student-name">${item.student.name}</div>
                <div class="student-id">ÙƒÙˆØ¯: ${item.id}</div>
                <div class="student-grade">${item.student.main}</div>
            </div>
        `;
    });
    
    html += '</div></div>';
    
    Swal.fire({
        title: 'Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«',
        html: html,
        showConfirmButton: false,
        width: '80%'
    });
}


// ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
function showStudentDetails(id) {
    if (!students[id]) {
        Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
        return;
    }
    
    const student = students[id];
    closeModal(); // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù†Ù…Ø§Ø°Ø¬ Ù…ÙØªÙˆØ­Ø©
    
    let qrCodeHtml = '';
    if (student.phone) {
        qrCodeHtml = `
            <div class="qr-code-container">
                <div id="qr-code-${id}" class="qr-code"></div>
                <p>QR Code Ù„Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</p>
            </div>
        `;
    }
    
    let imageHtml = '';
    if (student.image) {
        imageHtml = `
            <div class="image-upload">
                <img src="${student.image}" class="image-preview" style="display: block; max-width: 200px;" onclick="expandImage(this)">
            </div>
        `;
    }
    
    let studentCardHtml = generateStudentIdCard(id, student);
    
    let notesHtml = `
        <div class="notes-container">
            <div class="notes-header">
                <h3><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                <button class="btn btn-small" onclick="showNotesModal('${id}')">
                    <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
                </button>
            </div>
            <div class="notes-content" id="notes-display-${id}">
                ${student.notes || '<p style="color: var(--text-light); text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>'}
            </div>
        </div>
    `;
    
    let html = `
        <div class="student-detail-card">
            <div class="student-detail-header">
                <h2 class="student-detail-title"><i class="fas fa-user"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>

            <div class="student-detail-body">
                <div>
                    <div class="student-info-item">
                        <span class="student-info-label"><i class="fas fa-id-card"></i> ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨:</span>
                        <span class="student-info-value">${id}</span>
                    </div>
                    <div class="student-info-item">
                        <span class="student-info-label"><i class="fas fa-user"></i> Ø§Ù„Ø§Ø³Ù…:</span>
                        <span class="student-info-value">${student.name}</span>
                    </div>
                    <div class="student-info-item">
                        <span class="student-info-label"><i class="fas fa-graduation-cap"></i> Ø§Ù„ØµÙ:</span>
                        <span class="student-info-value">${student.main}</span>
                    </div>
                    <div class="student-info-item">
                        <span class="student-info-label"><i class="fas fa-users"></i> Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</span>
                        <span class="student-info-value">${student.group || '-'}</span>
                    </div>
                    <div class="student-info-item">
                        <span class="student-info-label"><i class="fas fa-school"></i> Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</span>
                        <span class="student-info-value">${student.school || '-'}</span>
                    </div>
                    <div class="student-info-item">
                        <span class="student-info-label"><i class="fas fa-calendar-day"></i> Ø§Ù„ÙŠÙˆÙ…:</span>
                        <span class="student-info-value">${student.day || '-'}</span>
                    </div>
                    ${student.phone ? `
                    <div class="student-info-item">
                        <span class="student-info-label"><i class="fas fa-phone"></i> Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ù„Ø£Ø¨):</span>
                        <span class="student-info-value">${student.phone}</span>
                    </div>
                    ` : ''}
                    ${student.motherPhone ? `
                    <div class="student-info-item">
                        <span class="student-info-label"><i class="fas fa-phone"></i> Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ù„Ø£Ù…):</span>
                        <span class="student-info-value">${student.motherPhone}</span>
                    </div>
                    ` : ''}
                    ${student._file ? `
                    <div class="student-info-item">
                        <span class="student-info-label"><i class="fas fa-file-alt"></i> Ù…Ù„Ù Ø§Ù„ØªØ®Ø²ÙŠÙ†:</span>
                        <span class="student-info-value">${student._file}</span>
                    </div>
                    ` : ''}
                </div>
                
                ${imageHtml}
                ${qrCodeHtml}
            </div>
            
            <div class="action-buttons">
                <button class="btn" onclick="showAttendancePopup('${id}')">
                    <i class="fas fa-calendar-check"></i> Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨
                </button>
                <button class="btn" onclick="showFeesPopup('${id}')">
                    <i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
                </button>
                <button class="btn" onclick="showNotesModal('${id}')">
                    <i class="fas fa-sticky-note"></i> Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                </button>
                <button class="btn" onclick="showWeeklyReportForm('${id}')">
                    <i class="fas fa-file-alt"></i> ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ
                </button>
                <button class="btn" onclick="scanQRCode('${id}')">
                    <i class="fas fa-qrcode"></i> Ù…Ø³Ø­ QR Code
                </button>
                ${student.phone ? `
                <button class="btn btn-success" onclick="generateQRCode('${id}', '${student.phone}')">
                    <i class="fas fa-qrcode"></i> Ø¥Ù†Ø´Ø§Ø¡ QR Code
                </button>
                ` : ''}
                <button class="btn btn-warning" onclick="showEditModal('${id}')">
                    <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
                <button class="btn btn-secondary" onclick="shareStudent('${id}')">
                    <i class="fas fa-share"></i> Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
                <button class="btn btn-primary" onclick="downloadStudentCard('${id}')">
                    <i class="fas fa-download"></i> Ø­ÙØ¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
                </button>
            </div>
            
            ${notesHtml}
            
            <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ -->
            ${studentCardHtml}
        </div>
    `;
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
    const detailModal = document.createElement('div');
    detailModal.className = 'modal';
    detailModal.id = 'studentDetailModal';
    detailModal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
            </div>
            <div class="modal-body" id="studentDetailContent">
                ${html}
            </div>
        </div>
    `;
    
    document.body.appendChild(detailModal);
    
    if (student.phone) {
        new QRCode(document.getElementById(`qr-code-${id}`), {
            text: JSON.stringify({
                id: id,
                phone: student.phone,
                action: 'attendance',
                group: student.group || 'default'
            }),
            width: 150,
            height: 150,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        
        const cardQrCodeDiv = document.getElementById(`qr-code-card-${id}`);
        if (cardQrCodeDiv) {
            new QRCode(cardQrCodeDiv, {
                text: JSON.stringify({
                    id: id,
                    phone: student.phone,
                    action: 'attendance',
                    group: student.group || 'default'
                }),
                width: 100,
                height: 100,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }
    }
    
    detailModal.style.display = 'block';
}

// ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
document.getElementById('saveStudentBtn').onclick = async function() {
    const id = document.getElementById('studentId').value;
    const name = document.getElementById('studentName').value.trim();
    const grade = document.getElementById('studentGrade').value;
    let group = document.getElementById('studentGroup').value;
    const phone = document.getElementById('studentPhone').value.trim();
    const motherPhone = document.getElementById('motherPhone').value.trim();
    const school = document.getElementById('schoolName').value.trim();
    const day = document.getElementById('studentday').value;
    let image = document.getElementById('studentImagePreview').src || '';

    if (!name || !grade) {
        Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ù„ØµÙ', 'warning');
        return;
    }

    // Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
    if (group === '_new_group_') {
        const { value: newGroup } = await Swal.fire({
            title: 'Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©',
            input: 'text',
            inputPlaceholder: 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
            showCancelButton: true,
            confirmButtonText: 'Ø¥Ù†Ø´Ø§Ø¡',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
            inputValidator: (value) => {
                if (!value) {
                    return 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©!';
                }
                if (groups.includes(value)) {
                    return 'Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„!';
                }
            }
        });

        if (!newGroup) return; // Ø¥Ø°Ø§ Ø¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„ØºØ§Ø¡

        group = newGroup;
        groups.push(group);
        await saveGroupsToGitHub();
        fillGroupSelects(); // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
    }

    if (image.includes('data:') && image.length < 30) image = '';

    const studentData = {
        name: name,
        main: grade,
        group: group,
        phone: phone,
        motherPhone: motherPhone,
        school: school,
        day: day,
        image: image,
        _file: currentDataFile
    };

    students[id] = studentData;
    allStudentsData[id] = studentData;

    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
    if (!currentStudentId) {
        sendNewStudentNotification(id, studentData);
        await saveToGitHub();
        closeModal();
        renderStudentCards();
        showStudentDetails(id); // Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    } else {
        await saveToGitHub();
        closeModal();
        renderStudentCards();
    }
};

// ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
function generateStudentIdCard(id, student) {
    return `
        <div class="id-card-container">
            <div class="student-id-card" id="student-card-${id}">
                <div class="card-header">
                    <h3>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                </div>
                <div class="card-body">
                    <div class="card-image">
                        ${student.image ? `<img src="${student.image}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨">` : '<i class="fas fa-user-circle"></i>'}
                    </div>
                    <div class="card-info">
                        <div class="info-row">
                            <span class="label">Ø§Ù„Ø§Ø³Ù…:</span>
                            <span class="value">${student.name}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Ø§Ù„ÙƒÙˆØ¯:</span>
                            <span class="value">${id}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Ø§Ù„ØµÙ:</span>
                            <span class="value">${student.main}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</span>
                            <span class="value">${student.group || '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Ø§Ù„ÙŠÙˆÙ…:</span>
                            <span class="value">${student.day || '-'}</span>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div id="qr-code-card-${id}" class="card-qr-code"></div>
                </div>
            </div>
        </div>
    `;
}

// ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
function closeModal() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
        if (modal.id !== 'studentDetailModal') {
            modal.remove();
        }
    });
}

window.onload = function() {
    if (localStorage.getItem("isLoggedIn") === "true") {
        document.getElementById("loginScreen").style.display = "none";
        loadAllStudentsData();
        loadPosts();
        loadTrash();
        loadWeeklyReports();
        loadGroups();
        fillGradeSelects();
        fillGroupSelects();
        const today = new Date();
        document.getElementById('currentDate').textContent = today.toLocaleDateString('ar-EG');
        
        // ØªØ­Ø³ÙŠÙ†Ø§Øª ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        document.getElementById('searchId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStudent();
            }
        });
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ®Ø²ÙŠÙ†
function determineCurrentFile() {
  const mainFileSize = calculateFileSize(allStudentsData);
  if (mainFileSize < MAX_FILE_SIZE) {
    currentDataFile = "students.json";
    students = allStudentsData;
    document.getElementById('currentDataFile').textContent = "students.json";
    document.getElementById('totalStudentsInFile').textContent = Object.keys(students).length;
    return;
  }
  
  let fileNumber = 1;
  let latestFile = null;
  let latestFileSize = 0;
  
  while (true) {
    const fileName = `students_${fileNumber}.json`;
    const fileData = {};
    
    for (const [id, student] of Object.entries(allStudentsData)) {
      if (student._file === fileName) {
        fileData[id] = student;
      }
    }
    
    const size = calculateFileSize(fileData);
    if (size > 0 && size < MAX_FILE_SIZE) {
      latestFile = fileName;
      latestFileSize = size;
    } else if (size === 0) {
      break;
    }
    
    fileNumber++;
  }
  
  if (latestFile) {
    currentDataFile = latestFile;
    students = {};
    for (const [id, student] of Object.entries(allStudentsData)) {
      if (student._file === latestFile) {
        students[id] = student;
      }
    }
    document.getElementById('currentDataFile').textContent = latestFile;
    document.getElementById('totalStudentsInFile').textContent = Object.keys(students).length;
  } else {
    createNewDataFile();
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„Ù…Ù„Ù
function calculateFileSize(data) {
  try {
    const jsonString = JSON.stringify(data);
    return new Blob([jsonString]).size;
  } catch (error) {
    console.error("Error calculating file size:", error);
    return 0;
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯
function createNewDataFile() {
  let fileNumber = 1;
  while (true) {
    const fileName = `students_${fileNumber}.json`;
    let fileExists = false;
    
    for (const student of Object.values(allStudentsData)) {
      if (student._file === fileName) {
        fileExists = true;
        break;
      }
    }
    
    if (!fileExists) {
      currentDataFile = fileName;
      students = {};
      document.getElementById('currentDataFile').textContent = fileName;
      document.getElementById('totalStudentsInFile').textContent = 0;
      break;
    }
    
    fileNumber++;
  }
}

async function loadPosts() {
  try {
    showLoading(true);
    let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`);
    if (!res.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª');
    
    let data = await res.json();
    let decodedContent = decodeURIComponent(escape(atob(data.content)));
    posts = JSON.parse(decodedContent);
    renderPosts();
  } catch (error) {
    console.error("Error loading posts:", error);
    posts = {};
    renderPosts();
    Swal.fire({
      title: 'ØªØ­Ø°ÙŠØ±',
      text: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø­Ø§Ù„ÙŠØ©ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸',
      icon: 'warning'
    });
  } finally {
    showLoading(false);
  }
}

async function loadTrash() {
  try {
    let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${trashPath}`);
    if (!res.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª');
    
    let data = await res.json();
    let decodedContent = decodeURIComponent(escape(atob(data.content)));
    trash = JSON.parse(decodedContent);
  } catch (error) {
    console.error("Error loading trash:", error);
    trash = {};
  }
}

async function loadWeeklyReports() {
  try {
    let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${reportsPath}`);
    if (!res.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©');
    
    let data = await res.json();
    let decodedContent = decodeURIComponent(escape(atob(data.content)));
    weeklyReports = JSON.parse(decodedContent);
    renderWeeklyReportsList();
  } catch (error) {
    console.error("Error loading weekly reports:", error);
    weeklyReports = {};
  }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ù† GitHub
async function loadGroups() {
  try {
    let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${groupsPath}`);
    if (!res.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª');
    
    let data = await res.json();
    let decodedContent = decodeURIComponent(escape(atob(data.content)));
    groups = JSON.parse(decodedContent);
    fillGroupSelects(); // ØªØ¹Ø¨Ø¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  } catch (error) {
    console.error("Error loading groups:", error);
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§ØªØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    groups = ["Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£", "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨", "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬", "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¯", "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù‡Ù€"];
    fillGroupSelects();
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙÙŠ GitHub
async function saveGroupsToGitHub() {
  const token = document.getElementById("token").value.trim();
  if (!token) {
    Swal.fire('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ GitHub Token', 'error');
    return;
  }
  
  const content = btoa(unescape(encodeURIComponent(JSON.stringify(groups, null, 2))));
  let shaVal = '';
  
  try {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${groupsPath}`);
    if (res.ok) {
      const data = await res.json();
      shaVal = data.sha;
    }
  } catch (error) {
    console.error("Error getting groups file SHA:", error);
  }
  
  await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${groupsPath}`, {
    method: 'PUT',
    headers: {
      'Authorization': `token ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      message: 'ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª',
      content: content,
      sha: shaVal
    })
  });
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
function showCreateGroupModal() {
  Swal.fire({
    title: 'Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©',
    input: 'text',
    inputPlaceholder: 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
    showCancelButton: true,
    confirmButtonText: 'Ø¥Ù†Ø´Ø§Ø¡',
    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
    inputValidator: (value) => {
      if (!value) {
        return 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©!';
      }
      if (groups.includes(value)) {
        return 'Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„!';
      }
    }
  }).then((result) => {
    if (result.isConfirmed) {
      const newGroup = result.value;
      groups.push(newGroup);
      saveGroupsToGitHub();
      fillGroupSelects(); // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
      Swal.fire('ØªÙ…!', `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© "${newGroup}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');
    }
  });
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© renderStudentCards Ù„Ø¯Ø¹Ù… Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
function renderStudentCards(filterGrade = null, filterGroup = null) {
  let html = '';
  let studentCount = 0;
  
  for (let id in students) {
    let s = students[id];
    if (filterGrade && s.main.trim() !== filterGrade.trim()) continue;
    if (filterGroup && s.group !== filterGroup) continue;

    studentCount++;
    
    let groupClass = s.group ? `group-${s.group.replace(' ', '-')}` : '';
    
    let imageThumb = '';
    if (s.image) {
      imageThumb = `<img src="${s.image}" class="student-image-thumb" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨">`;
    }
    
    html += `
      <div class="student-card ${groupClass}" id="student-card-${id}">
        ${imageThumb}
        <i class="fas fa-edit edit-student-btn" onclick="showEditModal('${id}')"></i>
        <div class="student-header" onclick="showStudentDetails('${id}')">
          <div>
            <div class="student-name">${s.name}</div>
            <div class="student-id">ÙƒÙˆØ¯: ${id}</div>
          </div>
          <div>
            <div class="student-grade">${s.main}</div>
            ${s.group ? `<span class="student-group">${s.group}</span>` : ''}
          </div>
        </div>
      </div>
    `;
  }
  
  document.getElementById('studentsCards').innerHTML = studentCount > 0 ? html : `
    <div class="no-students">
      <h3><i class="fas fa-info-circle"></i> Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
    </div>
  `;
  
  document.getElementById('studentsCountNumber').textContent = studentCount;
  updateStats();
}

function hideAllStudents() {
  document.getElementById('studentsCards').innerHTML = `
    <div class="no-students">
      <h3><i class="fas fa-eye-slash"></i> ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
      <button class="btn btn-success" onclick="showAllStudents()">
        <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨
      </button>
    </div>
  `;
}

function showAllStudents() {
  renderStudentCards();
}

function showStudentDetails(id) {
  const student = students[id];
  
  let qrCodeHtml = '';
  if (student.phone) {
    qrCodeHtml = `
      <div class="qr-code-container">
        <div id="qr-code-${id}" class="qr-code"></div>
        <p>QR Code Ù„Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</p>
      </div>
    `;
  }
  
  let imageHtml = '';
  if (student.image) {
    imageHtml = `
      <div class="image-upload">
        <img src="${student.image}" class="image-preview" style="display: block; max-width: 200px;" onclick="expandImage(this)">
      </div>
    `;
  }
  
  let studentCardHtml = generateStudentIdCard(id, student);
  
  let notesHtml = `
    <div class="notes-container">
      <div class="notes-header">
        <h3><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
        <button class="btn btn-small" onclick="showNotesModal('${id}')">
          <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
        </button>
      </div>
      <div class="notes-content" id="notes-display-${id}">
        ${student.notes || '<p style="color: var(--text-light); text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>'}
      </div>
    </div>
  `;
  
  let html = `
    <div class="student-detail-card">
      <div class="student-detail-header">
        <h2 class="student-detail-title"><i class="fas fa-user"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
      </div>

      <div class="student-detail-body">
        <div>
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-id-card"></i> ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨:</span>
            <span class="student-info-value">${id}</span>
          </div>
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-user"></i> Ø§Ù„Ø§Ø³Ù…:</span>
            <span class="student-info-value">${student.name}</span>
          </div>
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-graduation-cap"></i> Ø§Ù„ØµÙ:</span>
            <span class="student-info-value">${student.main}</span>
          </div>
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-users"></i> Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</span>
            <span class="student-info-value">${student.group || '-'}</span>
          </div>
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-school"></i> Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</span>
            <span class="student-info-value">${student.school || '-'}</span>
          </div>
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-calendar-day"></i> Ø§Ù„ÙŠÙˆÙ…:</span>
            <span class="student-info-value">${student.day || '-'}</span>
          </div>
          ${student.phone ? `
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-phone"></i> Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ù„Ø£Ø¨):</span>
            <span class="student-info-value">${student.phone}</span>
          </div>
          ` : ''}
          ${student.motherPhone ? `
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-phone"></i> Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ù„Ø£Ù…):</span>
            <span class="student-info-value">${student.motherPhone}</span>
          </div>
          ` : ''}
          ${student._file ? `
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-file-alt"></i> Ù…Ù„Ù Ø§Ù„ØªØ®Ø²ÙŠÙ†:</span>
            <span class="student-info-value">${student._file}</span>
          </div>
          ` : ''}
        </div>
        
        ${imageHtml}
        ${qrCodeHtml}
      </div>
      
      <div class="action-buttons">
        <button class="btn" onclick="showAttendancePopup('${id}')">
          <i class="fas fa-calendar-check"></i> Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨
        </button>
        <button class="btn" onclick="showFeesPopup('${id}')">
          <i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
        </button>
        <button class="btn" onclick="showNotesModal('${id}')">
          <i class="fas fa-sticky-note"></i> Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
        </button>
       
    <div class="weekly-reports-container">
        <div class="notes-header">
            <h3><i class="fas fa-file-alt"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù„Ù„Ø·Ø§Ù„Ø¨</h3>
            <button class="btn btn-small" onclick="showWeeklyReportForm('${id}')">
                <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ±
            </button>
        </div>
        <div class="weekly-reports-list" id="weekly-reports-${id}">
            ${renderStudentWeeklyReports(id)}
        </div>
    </div>
        <button class="btn" onclick="scanQRCode('${id}')">
          <i class="fas fa-qrcode"></i> Ù…Ø³Ø­ QR Code
        </button>
        ${student.phone ? `
        <button class="btn btn-success" onclick="generateQRCode('${id}', '${student.phone}')">
          <i class="fas fa-qrcode"></i> Ø¥Ù†Ø´Ø§Ø¡ QR Code
        </button>
        ` : ''}
        <button class="btn btn-warning" onclick="showEditModal('${id}')">
          <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
        <button class="btn btn-secondary" onclick="shareStudent('${id}')">
          <i class="fas fa-share"></i> Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
        <button class="btn btn-primary" onclick="downloadStudentCard('${id}')">
          <i class="fas fa-download"></i> Ø­ÙØ¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        </button>
      </div>
      
      ${notesHtml}
      
      <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ -->
      ${studentCardHtml}
    </div>
  `;
  
  document.getElementById('studentDetailContent').innerHTML = html;
  
  if (student.phone) {
    new QRCode(document.getElementById(`qr-code-${id}`), {
      text: JSON.stringify({
        id: id,
        phone: student.phone,
        action: 'attendance',
        group: student.group || 'default'
      }),
      width: 150,
      height: 150,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });
    
    const cardQrCodeDiv = document.getElementById(`qr-code-card-${id}`);
    if (cardQrCodeDiv) {
      new QRCode(cardQrCodeDiv, {
        text: JSON.stringify({
          id: id,
          phone: student.phone,
          action: 'attendance',
          group: student.group || 'default'
        }),
        width: 100,
        height: 100,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
    }
  }
  
  document.getElementById('studentDetailModal').style.display = 'block';
}

function renderStudentWeeklyReports(studentId) {
    let html = '';
    let hasReports = false;
    
    for (let reportId in weeklyReports) {
        const report = weeklyReports[reportId];
        if (report.studentId === studentId) {
            hasReports = true;
            html += `
                <div class="weekly-report-item">
                    <div class="report-header">
                        <span class="report-date">${report.date}</span>
                        <div class="report-actions">
                            <button class="btn btn-small btn-danger" onclick="deleteWeeklyReport('${reportId}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="report-details">
                        <div><strong>Ø§Ù„Ø­Ø¶ÙˆØ±:</strong> ${report.attendance}</div>
                        <div><strong>Ø§Ù„ÙˆØ§Ø¬Ø¨:</strong> ${report.homework}</div>
                        <div><strong>Ø§Ù„ÙƒÙ„Ù…Ø§Øª:</strong> ${report.words}</div>
                        <div><strong>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</strong> ${report.testScore}/15</div>
                        ${report.notes ? `<div><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${report.notes}</div>` : ''}
                    </div>
                </div>
            `;
        }
    }
    
    if (!hasReports) {
        html = '<p style="text-align: center; color: var(--text-light);">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨</p>';
    }
    
    return html;
}


async function deleteWeeklyReport(reportId) {
    const result = await Swal.fire({
        title: 'Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ±',
        text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŸ',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    
    if (result.isConfirmed) {
        delete weeklyReports[reportId];
        await saveWeeklyReportsToGitHub();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ø§Ù‹
        if (currentPopupStudentId) {
            document.getElementById(`weekly-reports-${currentPopupStudentId}`).innerHTML = 
                renderStudentWeeklyReports(currentPopupStudentId);
        }
        
        Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }
}

function expandImage(img) {
    if (!img.src) return;
    document.getElementById('expandedImage').src = img.src;
    document.getElementById('imageModal').style.display = 'block';
}

function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

function closeModal() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
    });
}

function showAddModal() {
    currentStudentId = null;
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯';
    document.getElementById('studentId').value = generateStudentId();
    document.getElementById('studentName').value = '';
    document.getElementById('studentGrade').selectedIndex = 0;
    document.getElementById('studentGroup').selectedIndex = 0;
    document.getElementById('studentPhone').value = '';
    document.getElementById('motherPhone').value = '';
    document.getElementById('schoolName').value = '';
    document.getElementById('studentday').selectedIndex = 0;
    document.getElementById('studentImagePreview').style.display = 'none';
    document.getElementById('imageActions').style.display = 'none';
    document.getElementById('studentImage').value = '';
    studentImageFile = null;
    document.getElementById('studentModal').style.display = 'block';
}

function showEditModal(id) {
    currentStudentId = id;
    const s = students[id];
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨';
    document.getElementById('studentId').value = id;
    document.getElementById('studentName').value = s.name || '';
    document.getElementById('studentGrade').value = s.main || '';
    document.getElementById('studentGroup').value = s.group || '';
    document.getElementById('studentPhone').value = s.phone || '';
    document.getElementById('motherPhone').value = s.motherPhone || '';
    document.getElementById('schoolName').value = s.school || '';
    document.getElementById('studentday').value = s.day || '';
    if (s.image) {
        document.getElementById('studentImagePreview').src = s.image;
        document.getElementById('studentImagePreview').style.display = 'block';
        document.getElementById('imageActions').style.display = 'flex';
    } else {
        document.getElementById('studentImagePreview').style.display = 'none';
        document.getElementById('imageActions').style.display = 'none';
    }
    studentImageFile = null;
    document.getElementById('studentModal').style.display = 'block';
}

function previewStudentImage() {
    const input = document.getElementById('studentImage');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('studentImagePreview').src = e.target.result;
            document.getElementById('studentImagePreview').style.display = 'block';
            document.getElementById('imageActions').style.display = 'flex';
            studentImageFile = input.files[0];
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function removeImage() {
    document.getElementById('studentImagePreview').src = '';
    document.getElementById('studentImagePreview').style.display = 'none';
    document.getElementById('imageActions').style.display = 'none';
    document.getElementById('studentImage').value = '';
    studentImageFile = null;
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ø¯Ø¹Ù… Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
document.getElementById('saveStudentBtn').onclick = async function() {
    const id = document.getElementById('studentId').value;
    const name = document.getElementById('studentName').value.trim();
    const grade = document.getElementById('studentGrade').value;
    let group = document.getElementById('studentGroup').value;
    const phone = document.getElementById('studentPhone').value.trim();
    const motherPhone = document.getElementById('motherPhone').value.trim();
    const school = document.getElementById('schoolName').value.trim();
    const day = document.getElementById('studentday').value;
    let image = document.getElementById('studentImagePreview').src || '';

    if (!name || !grade) {
        Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ù„ØµÙ', 'warning');
        return;
    }

    // Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
    if (group === '_new_group_') {
      const { value: newGroup } = await Swal.fire({
        title: 'Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©',
        input: 'text',
        inputPlaceholder: 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
        showCancelButton: true,
        confirmButtonText: 'Ø¥Ù†Ø´Ø§Ø¡',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        inputValidator: (value) => {
          if (!value) {
            return 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©!';
          }
          if (groups.includes(value)) {
            return 'Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„!';
          }
        }
      });

      if (!newGroup) return; // Ø¥Ø°Ø§ Ø¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„ØºØ§Ø¡

      group = newGroup;
      groups.push(group);
      await saveGroupsToGitHub();
      fillGroupSelects(); // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
    }

    if (image.includes('data:') && image.length < 30) image = '';

    const studentData = {
        name: name,
        main: grade,
        group: group,
        phone: phone,
        motherPhone: motherPhone,
        school: school,
        day: day,
        image: image,
        _file: currentDataFile
    };

    students[id] = studentData;
    allStudentsData[id] = studentData;

    if (!currentStudentId) sendNewStudentNotification(id, studentData);

    if (!currentStudentId && day) {
        if (!students[id].attendance) students[id].attendance = {};
        students[id].attendance[day] = 'Ø­Ø§Ø¶Ø±';
    }

    await saveToGitHub();
    closeModal();
    renderStudentCards();
    fillGradeSelects();
    fillGroupSelects();
};

function showDeleteModal(id) {
    deleteStudentId = id;
    document.getElementById('deleteStudentSelectContainer').style.display = 'block';
    document.getElementById('deleteStudentInfo').style.display = 'none';
    const select = document.getElementById('deleteStudentSelect');
    select.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ø­Ø°Ù</option>';
    for (let sid in students) {
        select.innerHTML += `<option value="${sid}">${sid} - ${students[sid].name}</option>`;
    }
    select.onchange = function() {
        const sid = this.value;
        if (students[sid]) {
            document.getElementById('deleteStudentName').textContent = students[sid].name;
            document.getElementById('deleteStudentId').textContent = sid;
            document.getElementById('deleteStudentGrade').textContent = students[sid].main;
            document.getElementById('deleteStudentInfo').style.display = 'block';
            deleteStudentId = sid;
        }
    };
    document.getElementById('deleteModal').style.display = 'block';
}

async function confirmDelete() {
    if (!deleteStudentId || !students[deleteStudentId]) {
        Swal.fire('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ø­Ø°Ù', 'error');
        return;
    }
    trash[deleteStudentId] = students[deleteStudentId];
    delete students[deleteStudentId];
    delete allStudentsData[deleteStudentId];
    await saveToGitHub();
    closeModal();
    renderStudentCards();
}

function showNotesModal(id) {
    currentStudentId = id;
    document.getElementById('notesContent').value = students[id].notes || '';
    document.getElementById('notesModal').style.display = 'block';
}

async function saveNotes() {
    if (!currentStudentId || !students[currentStudentId]) return;
    students[currentStudentId].notes = document.getElementById('notesContent').value;
    allStudentsData[currentStudentId].notes = students[currentStudentId].notes;
    sendNotesNotification(currentStudentId, students[currentStudentId], students[currentStudentId].notes);
    await saveToGitHub();
    closeModal();
    renderStudentCards();
}

function showPostModal() {
    currentPostId = null;
    document.getElementById('postModalTitle').innerHTML = '<i class="fas fa-plus"></i> Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯';
    document.getElementById('editPostTitle').value = '';
    document.getElementById('editPostContent').value = '';
    document.getElementById('postImagePreview').style.display = 'none';
    document.getElementById('postImageActions').style.display = 'none';
    document.getElementById('postImageInput').value = '';
    postImageFile = null;
    document.getElementById('postModal').style.display = 'block';
}

function previewPostImage() {
    const input = document.getElementById('postImageInput');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('postImagePreview').src = e.target.result;
            document.getElementById('postImagePreview').style.display = 'block';
            document.getElementById('postImageActions').style.display = 'flex';
            postImageFile = input.files[0];
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function removePostImage() {
    document.getElementById('postImagePreview').src = '';
    document.getElementById('postImagePreview').style.display = 'none';
    document.getElementById('postImageActions').style.display = 'none';
    document.getElementById('postImageInput').value = '';
    postImageFile = null;
}

document.getElementById('savePostBtn').onclick = async function() {
    const title = document.getElementById('editPostTitle').value.trim();
    const content = document.getElementById('editPostContent').value.trim();
    let image = document.getElementById('postImagePreview').src || '';
    if (!title || !content) {
        Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ± ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰', 'warning');
        return;
    }
    if (image.includes('data:') && image.length < 30) image = '';
    const postId = currentPostId || Date.now().toString();
    posts[postId] = {
        title: title,
        content: content,
        image: image,
        date: new Date().toLocaleString('ar-EG')
    };
    await savePostsToGitHub();
    closePostModal();
    renderPosts();
};

function closePostModal() {
    document.getElementById('postModal').style.display = 'none';
}

function renderPosts() {
    let html = '';
    for (let id in posts) {
        const p = posts[id];
        html += `
            <div class="post">
                <div class="post-header">
                    <div class="post-avatar"><i class="fas fa-user"></i></div>
                    <div>
                        <div class="post-author">${p.title}</div>
                        <div class="post-date">${p.date}</div>
                    </div>
                </div>
                <div class="post-content">${p.content}</div>
                ${p.image ? `<img src="${p.image}" class="post-image" onclick="expandImage(this)">` : ''}
            </div>
        `;
    }
    document.getElementById('postsList').innerHTML = html || '<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
}

async function savePostsToGitHub() {
    const token = document.getElementById('token').value.trim();
    if (!token) {
        Swal.fire('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ GitHub Token', 'error');
        return;
    }
    localStorage.setItem('gh_token', token);
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(posts, null, 2))));
    let shaVal = '';
    try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`);
        if (res.ok) {
            const data = await res.json();
            shaVal = data.sha;
        }
    } catch {}
    await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message: 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª',
            content: content,
            sha: shaVal
        })
    });
}

async function saveToGitHub() {
    const token = document.getElementById('token').value.trim();
    if (!token) {
        Swal.fire('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ GitHub Token', 'error');
        return;
    }
    localStorage.setItem('gh_token', token);
    const studentsContent = btoa(unescape(encodeURIComponent(JSON.stringify(students, null, 2))));
    let shaVal = sha;
    try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${currentDataFile}`);
        if (res.ok) {
            const data = await res.json();
            shaVal = data.sha;
        }
    } catch {}
    await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${currentDataFile}`, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message: 'ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨',
            content: studentsContent,
            sha: shaVal
        })
    });
    const trashContent = btoa(unescape(encodeURIComponent(JSON.stringify(trash, null, 2))));
    let trashSha = '';
    try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${trashPath}`);
        if (res.ok) {
            const data = await res.json();
            trashSha = data.sha;
        }
    } catch {}
    await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${trashPath}`, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message: 'ØªØ­Ø¯ÙŠØ« Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª',
            content: trashContent,
            sha: trashSha
        })
    });
    Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ GitHub', 'success');
}

function showTrash() {
    let html = '';
    for (let id in trash) {
        const s = trash[id];
        html += `
            <div class="trash-item">
                <div class="trash-info">
                    <div><strong>${s.name}</strong> (${id})</div>
                    <div>${s.main}</div>
                </div>
                <div class="trash-actions">
                    <button class="btn btn-success btn-small" onclick="restoreStudent('${id}')">
                        <i class="fas fa-undo"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                    </button>
                    <button class="btn btn-danger btn-small" onclick="deleteStudentForever('${id}')">
                        <i class="fas fa-trash"></i> Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
                    </button>
                </div>
            </div>
        `;
    }
    document.getElementById('trashContent').innerHTML = html || '<p style="text-align:center;">Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª ÙØ§Ø±ØºØ©</p>';
    document.getElementById('trashModal').style.display = 'block';
}

async function restoreStudent(id) {
    if (!trash[id]) return;
    students[id] = trash[id];
    allStudentsData[id] = trash[id];
    delete trash[id];
    await saveToGitHub();
    showTrash();
    renderStudentCards();
}

async function deleteStudentForever(id) {
    if (!trash[id]) return;
    delete trash[id];
    await saveToGitHub();
    showTrash();
}

function searchStudent() {
    const searchTerm = document.getElementById('searchId').value.trim().toLowerCase();
    if (!searchTerm) {
        Swal.fire('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„Ø¨Ø­Ø«', 'error');
        return;
    }
    
    let found = false;
    for (let id in students) {
        const s = students[id];
        if (id.includes(searchTerm)) {
            showStudentDetails(id);
            found = true;
            break;
        } else if (s.name.toLowerCase().includes(searchTerm)) {
            showStudentDetails(id);
            found = true;
            break;
        } else if ((s.phone && s.phone.includes(searchTerm)) || (s.motherPhone && s.motherPhone.includes(searchTerm))) {
            showStudentDetails(id);
            found = true;
            break;
        }
    }
    
    if (!found) {
        Swal.fire('Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ø§Ù„Ø¨ Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}

function shareStudentViaWhatsapp(id) {
    if (!students[id]) return;
    const s = students[id];
    const msg = `Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨:\nØ§Ù„Ø§Ø³Ù…: ${s.name}\nØ§Ù„ÙƒÙˆØ¯: ${id}\nØ§Ù„ØµÙ: ${s.main}\nØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${s.group || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\nØ§Ù„Ù…Ø¯Ø±Ø³Ø©: ${s.school || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\nØ§Ù„ÙŠÙˆÙ…: ${s.day || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n${s.phone ? 'Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ù„Ø£Ø¨): ' + s.phone : ''}\n${s.motherPhone ? 'Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ù„Ø£Ù…): ' + s.motherPhone : ''}`;
    sendWhatsAppNotification(s.phone, msg);
    if (s.motherPhone) {
        sendWhatsAppNotification(s.motherPhone, msg);
    }
}

function shareStudentViaTelegram(id) {
    if (!students[id]) return;
    const s = students[id];
    const msg = `Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨:\nØ§Ù„Ø§Ø³Ù…: ${s.name}\nØ§Ù„ÙƒÙˆØ¯: ${id}\nØ§Ù„ØµÙ: ${s.main}\nØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${s.group || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\nØ§Ù„Ù…Ø¯Ø±Ø³Ø©: ${s.school || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\nØ§Ù„ÙŠÙˆÙ…: ${s.day || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n${s.phone ? 'Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ù„Ø£Ø¨): ' + s.phone : ''}\n${s.motherPhone ? 'Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ù„Ø£Ù…): ' + s.motherPhone : ''}`;
    const url = `https://t.me/share/url?url=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');
}

function shareStudent(id) {
    if (!students[id]) return;
    const s = students[id];
    const msg = `Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨:\nØ§Ù„Ø§Ø³Ù…: ${s.name}\nØ§Ù„ÙƒÙˆØ¯: ${id}\nØ§Ù„ØµÙ: ${s.main}\nØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${s.group || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\nØ§Ù„Ù…Ø¯Ø±Ø³Ø©: ${s.school || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\nØ§Ù„ÙŠÙˆÙ…: ${s.day || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n${s.phone ? 'Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ù„Ø£Ø¨): ' + s.phone : ''}\n${s.motherPhone ? 'Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ù„Ø£Ù…): ' + s.motherPhone : ''}`;
    if (navigator.share) {
        navigator.share({
            title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨',
            text: msg
        });
    } else {
        Swal.fire('Ù…Ø´Ø§Ø±ÙƒØ©', 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­Ø§ÙØ¸Ø©', 'success');
        navigator.clipboard.writeText(msg);
    }
}

function downloadStudentCard(id) {
    const card = document.getElementById(`student-card-${id}`);
    if (!card) return;
    html2canvas(card).then(canvas => {
        canvas.toBlob(function(blob) {
            saveAs(blob, `student_card_${id}.png`);
        });
    });
}

function showAttendancePopup(id) {
    currentPopupStudentId = id;
    const s = students[id];
    let html = '<div class="day-selector">';
    weekDays.forEach(day => {
        const status = s.attendance && s.attendance[day] ? s.attendance[day] : '';
        html += `<div class="day-item ${status === 'Ø­Ø§Ø¶Ø±' ? 'present' : status === 'ØºØ§Ø¦Ø¨' ? 'absent' : ''}" onclick="toggleAttendance('${id}','${day}')">
            ${day} ${status ? `<span style="font-size:14px;">(${status})</span>` : ''}
        </div>`;
    });
    html += '</div>';
    document.getElementById('attendancePopupBody').innerHTML = html;
    document.getElementById('attendancePopup').style.display = 'flex';
}

function closeAttendancePopup() {
    document.getElementById('attendancePopup').style.display = 'none';
}

function toggleAttendance(id, day) {
    const s = students[id];
    if (!s.attendance) s.attendance = {};
    s.attendance[day] = s.attendance[day] === 'Ø­Ø§Ø¶Ø±' ? 'ØºØ§Ø¦Ø¨' : 'Ø­Ø§Ø¶Ø±';
    sendAttendanceNotification(id, s, day, s.attendance[day]);
    showAttendancePopup(id);
}

async function saveAttendance() {
    await saveToGitHub();
    closeAttendancePopup();
    renderStudentCards();
}

function showFeesPopup(id) {
    currentPopupStudentId = id;
    const s = students[id];
    let html = '<div class="month-selector">';
    months.forEach(month => {
        const status = s.fees && s.fees[month] ? s.fees[month] : '';
        html += `<div class="month-item ${status === 'Ù…Ø³Ø¯Ø¯Ø©' ? 'paid' : status === 'ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø©' ? 'unpaid' : ''}" onclick="toggleFees('${id}','${month}')">
            ${month} ${status ? `<span style="font-size:14px;">(${status})</span>` : ''}
        </div>`;
    });
    html += '</div>';
    document.getElementById('feesPopupBody').innerHTML = html;
    document.getElementById('feesPopup').style.display = 'flex';
}

function closeFeesPopup() {
    document.getElementById('feesPopup').style.display = 'none';
}

function toggleFees(id, month) {
    const s = students[id];
    if (!s.fees) s.fees = {};
    s.fees[month] = s.fees[month] === 'Ù…Ø³Ø¯Ø¯Ø©' ? 'ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø©' : 'Ù…Ø³Ø¯Ø¯Ø©';
    sendFeesNotification(id, s, month, s.fees[month] === 'Ù…Ø³Ø¯Ø¯Ø©');
    showFeesPopup(id);
}

async function saveFees() {
    await saveToGitHub();
    closeFeesPopup();
    renderStudentCards();
}

function updateStats() {
    document.getElementById('totalStudentsCount').textContent = Object.keys(students).length;
    let present = 0, absent = 0, paid = 0, unpaid = 0;
    const today = new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
    for (let id in students) {
        const s = students[id];
        if (s.attendance && s.attendance[today] === 'Ø­Ø§Ø¶Ø±') present++;
        else absent++;
        let paidMonths = 0, unpaidMonths = 0;
        if (s.fees) {
            months.forEach(month => {
                if (s.fees[month] === 'Ù…Ø³Ø¯Ø¯Ø©') paidMonths++;
                else if (s.fees[month] === 'ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø©') unpaidMonths++;
            });
        }
        if (paidMonths > 0) paid++;
        if (unpaidMonths > 0) unpaid++;
    }
    document.getElementById('todayPresentCount').textContent = present;
    document.getElementById('todayAbsentCount').textContent = absent;
    document.getElementById('paidFeesCount').textContent = paid;
    document.getElementById('unpaidFeesCount').textContent = unpaid;
}

function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    if (tab === 'students') {
        document.querySelector('.tab:nth-child(1)').classList.add('active');
        document.getElementById('students-tab').classList.add('active');
    } else if (tab === 'posts') {
        document.querySelector('.tab:nth-child(2)').classList.add('active');
        document.getElementById('posts-tab').classList.add('active');
    } else if (tab === 'reports') {
        document.querySelector('.tab:nth-child(3)').classList.add('active');
        document.getElementById('reports-tab').classList.add('active');
    }
}

function showReports(type) {
    document.querySelectorAll('.report-section').forEach(s => s.classList.remove('active'));
    if (type === 'fees') document.getElementById('feesReport').classList.add('active');
    else if (type === 'attendance') document.getElementById('attendanceReport').classList.add('active');
    else if (type === 'stats') document.getElementById('statsReport').classList.add('active');
    else if (type === 'weekly') document.getElementById('weeklyReport').classList.add('active');
}

function exportToExcel() {
    const table = document.getElementById('feesReportTable');
    const wb = XLSX.utils.table_to_book(table, {sheet:"ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª"});
    XLSX.writeFile(wb, 'fees_report.xlsx');
}

function exportAttendanceToExcel() {
    const table = document.getElementById('attendanceReportTable');
    const wb = XLSX.utils.table_to_book(table, {sheet:"ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ±"});
    XLSX.writeFile(wb, 'attendance_report.xlsx');
}

function filterFeesReport() {
    const grade = document.getElementById('feesGradeFilter').value;
    const group = document.getElementById('feesGroupFilter').value;
    const month = document.getElementById('feesMonthFilter').value;
    const status = document.getElementById('feesStatusFilter').value;
    let html = '';
    for (let id in students) {
        const s = students[id];
        if (grade && s.main !== grade) continue;
        if (group && s.group !== group) continue;
        let row = `<tr><td>${id}</td><td>${s.name}</td><td>${s.main}</td><td>${s.group || '-'}</td>`;
        let showRow = false;
        months.forEach(m => {
            let val = s.fees && s.fees[m] ? s.fees[m] : '';
            if (month && m !== month) val = '';
            if (status && val !== (status === 'paid' ? 'Ù…Ø³Ø¯Ø¯Ø©' : 'ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø©')) val = '';
            if (val) showRow = true;
            row += `<td>${val}</td>`;
        });
        row += '</tr>';
        if (showRow || (!month && !status)) html += row;
    }
    document.getElementById('feesReportBody').innerHTML = html;
}

function filterAttendanceReport() {
    const grade = document.getElementById('attendanceGradeFilter').value;
    const group = document.getElementById('attendanceGroupFilter').value;
    const day = document.getElementById('attendanceDayFilter').value;
    const status = document.getElementById('attendanceStatusFilter').value;
    let html = '';
    for (let id in students) {
        const s = students[id];
        if (grade && s.main !== grade) continue;
        if (group && s.group !== group) continue;
        let row = `<tr><td>${id}</td><td>${s.name}</td><td>${s.main}</td><td>${s.group || '-'}</td>`;
        let showRow = false;
        weekDays.forEach(d => {
            let val = s.attendance && s.attendance[d] ? s.attendance[d] : '';
            if (day && d !== day) val = '';
            if (status && val !== status) val = '';
            if (val) showRow = true;
            row += `<td>${val}</td>`;
        });
        row += '</tr>';
        if (showRow || (!day && !status)) html += row;
    }
    document.getElementById('attendanceReportBody').innerHTML = html;
}

function showWeeklyReportForm(id) {
    document.getElementById('reportStudentSelect').value = id;
    document.getElementById('weeklyReport').classList.add('active');
}

document.querySelectorAll('#reportStudentSelect, #reportDate, #reportAttendance, #reportHomework, #reportWords, #reportTestScore, #reportNotes').forEach(el => {
    el && el.addEventListener('input', updateWeeklyReportPreview);
});
function updateWeeklyReportPreview() {
    document.getElementById('previewDate').textContent = document.getElementById('reportDate').value;
    document.getElementById('previewAttendance').textContent = document.getElementById('reportAttendance').value;
    document.getElementById('previewHomework').textContent = document.getElementById('reportHomework').value;
    document.getElementById('previewWords').textContent = document.getElementById('reportWords').value;
    document.getElementById('previewTestScore').textContent = document.getElementById('reportTestScore').value + '/15';
    document.getElementById('previewNotes').textContent = document.getElementById('reportNotes').value || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª';
}

function clearReportForm() {
    document.getElementById('reportStudentSelect').selectedIndex = 0;
    document.getElementById('reportDate').value = '';
    document.getElementById('reportAttendance').selectedIndex = 0;
    document.getElementById('reportHomework').selectedIndex = 0;
    document.getElementById('reportWords').selectedIndex = 0;
    document.getElementById('reportTestScore').value = '';
    document.getElementById('reportNotes').value = '';
    updateWeeklyReportPreview();
}

async function saveWeeklyReport() {
    const studentId = document.getElementById('reportStudentSelect').value;
    if (!studentId || !students[studentId]) {
        Swal.fire('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨', 'error');
        return;
    }
    const reportData = {
        studentId: studentId,
        date: document.getElementById('reportDate').value,
        attendance: document.getElementById('reportAttendance').value,
        homework: document.getElementById('reportHomework').value,
        words: document.getElementById('reportWords').value,
        testScore: document.getElementById('reportTestScore').value,
        notes: document.getElementById('reportNotes').value
    };
    const reportId = Date.now().toString();
    weeklyReports[reportId] = reportData;
    await saveWeeklyReportsToGitHub();
    renderWeeklyReportsList();
    Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

function sendReportToWhatsApp() {
    const studentId = document.getElementById('reportStudentSelect').value;
    if (!studentId || !students[studentId]) return;
    const reportData = {
        date: document.getElementById('reportDate').value,
        attendance: document.getElementById('reportAttendance').value,
        homework: document.getElementById('reportHomework').value,
        words: document.getElementById('reportWords').value,
        testScore: document.getElementById('reportTestScore').value,
        notes: document.getElementById('reportNotes').value
    };
    sendWeeklyReportNotification(studentId, students[studentId], reportData);
}

async function saveWeeklyReportsToGitHub() {
    const token = document.getElementById('token').value.trim();
    if (!token) {
        Swal.fire('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ GitHub Token', 'error');
        return;
    }
    localStorage.setItem('gh_token', token);
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(weeklyReports, null, 2))));
    let shaVal = '';
    try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${reportsPath}`);
        if (res.ok) {
            const data = await res.json();
            shaVal = data.sha;
        }
    } catch {}
    await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${reportsPath}`, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message: 'ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©',
            content: content,
            sha: shaVal
        })
    });
}

function renderWeeklyReportsList() {
    let html = '';
    for (let id in weeklyReports) {
        const r = weeklyReports[id];
        html += `
            <div class="weekly-report">
                <div><strong>Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> ${r.studentId} - ${students[r.studentId] ? students[r.studentId].name : ''}</div>
                <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${r.date}</div>
                <div><strong>Ø§Ù„Ø­Ø¶ÙˆØ±:</strong> ${r.attendance}</div>
                <div><strong>Ø§Ù„ÙˆØ§Ø¬Ø¨:</strong> ${r.homework}</div>
                <div><strong>Ø§Ù„ÙƒÙ„Ù…Ø§Øª:</strong> ${r.words}</div>
                <div><strong>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</strong> ${r.testScore}/15</div>
                <div><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${r.notes}</div>
            </div>
        `;
    }
    document.getElementById('reportsListContainer').innerHTML = html || '<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©</p>';
}

function showGradeModal() {
    Swal.fire({
        title: 'ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„ØµÙ',
        html: `
            <select id="gradeFilter" class="swal2-select" style="width:100%; padding:10px; margin:10px 0;">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
                ${grades.map(grade => `<option value="${grade}">${grade}</option>`).join('')}
            </select>
            <select id="groupFilter" class="swal2-select" style="width:100%; padding:10px; margin:10px 0;">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>
                ${groups.map(group => `<option value="${group}">${group}</option>`).join('')}
            </select>
        `,
        showCancelButton: true,
        confirmButtonText: 'ØªØµÙÙŠØ©',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        preConfirm: () => {
            const grade = document.getElementById('gradeFilter').value;
            const group = document.getElementById('groupFilter').value;
            return { grade, group };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            renderStudentCards(result.value.grade, result.value.group);
        }
    });
}

function showGroupModal() {
    Swal.fire({
        title: 'ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©',
        html: `
            <select id="groupFilter" class="swal2-select" style="width:100%; padding:10px; margin:10px 0;">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>
                ${groups.map(group => `<option value="${group}">${group}</option>`).join('')}
                <option value="_new_group_">+ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</option>
            </select>
        `,
        showCancelButton: true,
        confirmButtonText: 'ØªØµÙÙŠØ©',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        preConfirm: () => {
            const group = document.getElementById('groupFilter').value;
            return { group };
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            if (result.value.group === '_new_group_') {
                const { value: newGroup } = await Swal.fire({
                    title: 'Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©',
                    input: 'text',
                    inputPlaceholder: 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
                    showCancelButton: true,
                    confirmButtonText: 'Ø¥Ù†Ø´Ø§Ø¡',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                    inputValidator: (value) => {
                        if (!value) {
                            return 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©!';
                        }
                        if (groups.includes(value)) {
                            return 'Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„!';
                        }
                    }
                });

                if (newGroup) {
                    groups.push(newGroup);
                    await saveGroupsToGitHub();
                    renderStudentCards(null, newGroup);
                    fillGroupSelects();
                }
            } else {
                renderStudentCards(null, result.value.group);
            }
        }
    });
}

window.onload = function() {
    if (localStorage.getItem("isLoggedIn") === "true") {
        document.getElementById("loginScreen").style.display = "none";
        loadAllStudentsData();
        loadPosts();
        loadTrash();
        loadWeeklyReports();
        loadGroups(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        fillGradeSelects();
        fillGroupSelects();
        const today = new Date();
        document.getElementById('currentDate').textContent = today.toLocaleDateString('ar-EG');
    }
};

function showLoading(show) {
    if (show) {
        Swal.fire({
            title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...',
            html: '<div class="spinner"></div>',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    } else {
        Swal.close();
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø¹ Ø¥Ø®ÙØ§Ø¡ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
function showNotesModal(id) {
    currentStudentId = id;
    
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
    document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
    });
    
    // ØªØ¹Ø¨Ø¦Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    document.getElementById('notesContent').value = students[id].notes || '';
    
    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø®ØµØµØ©
    const notesModal = document.createElement('div');
    notesModal.className = 'modal';
    notesModal.id = 'customNotesModal';
    notesModal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨: ${students[id].name}</h3>
                <span class="close" onclick="closeNotesModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <textarea id="notesContent" rows="8" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨..." 
                              style="width: 100%; border-radius: 8px; padding: 15px; border: 1px solid var(--gray-light);"></textarea>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn" onclick="closeNotesModal()">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
                <button class="btn btn-success" onclick="saveNotes()">
                    <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                </button>
                <button class="btn btn-primary" onclick="showAllNotes()">
                    <i class="fas fa-list"></i> Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(notesModal);
    document.getElementById('customNotesModal').style.display = 'block';
    document.getElementById('notesContent').value = students[id].notes || '';
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
function closeNotesModal() {
    const modal = document.getElementById('customNotesModal');
    if (modal) {
        modal.remove();
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø¬Ø§Ù†Ø¨ÙŠØ©
function showAllNotes(filterGrade = null, filterGroup = null, filterStudent = null) {
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
    document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
    });
    
    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
    const allNotesModal = document.createElement('div');
    allNotesModal.className = 'modal';
    allNotesModal.id = 'allNotesModal';
    allNotesModal.style.width = '90%';
    allNotesModal.style.maxWidth = '1000px';
    
    let html = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-sticky-note"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
                <span class="close" onclick="closeAllNotesModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="notes-filter">
                    <select id="notesGradeFilter" class="form-control">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
                        ${grades.map(grade => `<option value="${grade}">${grade}</option>`).join('')}
                    </select>
                    
                    <select id="notesGroupFilter" class="form-control">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>
                        ${groups.map(group => `<option value="${group}">${group}</option>`).join('')}
                    </select>
                    
                    <input type="text" id="notesStudentFilter" class="form-control" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯">
                    
                    <button class="btn" onclick="filterNotes()">
                        <i class="fas fa-filter"></i> ØªØµÙÙŠØ©
                    </button>
                </div>
                
                <div class="notes-list" id="notesListContainer">
                    ${generateNotesList(filterGrade, filterGroup, filterStudent)}
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn" onclick="closeAllNotesModal()">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
                <button class="btn btn-success" onclick="exportNotesToExcel()">
                    <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
                </button>
            </div>
        </div>
    `;
    
    allNotesModal.innerHTML = html;
    document.body.appendChild(allNotesModal);
    document.getElementById('allNotesModal').style.display = 'block';
    
    // ØªØ¹ÙŠÙŠÙ† Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØªØµÙÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (filterGrade) document.getElementById('notesGradeFilter').value = filterGrade;
    if (filterGroup) document.getElementById('notesGroupFilter').value = filterGroup;
    if (filterStudent) document.getElementById('notesStudentFilter').value = filterStudent;
}

// Ø¯Ø§Ù„Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
function generateNotesList(gradeFilter = null, groupFilter = null, studentFilter = null) {
    let html = '';
    let hasNotes = false;
    
    for (let id in students) {
        const s = students[id];
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØªØµÙÙŠØ©
        if (gradeFilter && s.main !== gradeFilter) continue;
        if (groupFilter && s.group !== groupFilter) continue;
        if (studentFilter && 
            !s.name.includes(studentFilter) && 
            !id.includes(studentFilter)) continue;
        
        if (s.notes) {
            hasNotes = true;
            html += `
                <div class="note-item">
                    <div class="note-header">
                        <h4>${s.name} (${id})</h4>
                        <div class="note-meta">
                            <span>${s.main}</span>
                            ${s.group ? `<span>${s.group}</span>` : ''}
                            <button class="btn btn-small" onclick="showNotesModal('${id}')">
                                <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
                            </button>
                        </div>
                    </div>
                    <div class="note-content">
                        ${s.notes}
                    </div>
                </div>
            `;
        }
    }
    
    if (!hasNotes) {
        html = '<div class="no-notes"><i class="fas fa-info-circle"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø©</div>';
    }
    
    return html;
}

// Ø¯Ø§Ù„Ø© Ù„ØªØµÙÙŠØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
function filterNotes() {
    const grade = document.getElementById('notesGradeFilter').value;
    const group = document.getElementById('notesGroupFilter').value;
    const student = document.getElementById('notesStudentFilter').value;
    
    document.getElementById('notesListContainer').innerHTML = generateNotesList(grade, group, student);
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ ÙˆØ§Ø¬Ù‡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
function closeAllNotesModal() {
    const modal = document.getElementById('allNotesModal');
    if (modal) {
        modal.remove();
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
async function saveNotes() {
    if (!currentStudentId || !students[currentStudentId]) return;
    
    const notesContent = document.getElementById('notesContent').value;
    students[currentStudentId].notes = notesContent;
    allStudentsData[currentStudentId].notes = notesContent;
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ù‚Ù… Ù‡Ø§ØªÙ
    sendNotesNotification(currentStudentId, students[currentStudentId], notesContent);
    
    await saveToGitHub();
    
    Swal.fire({
        title: 'ØªÙ… Ø§Ù„Ø­ÙØ¸',
        text: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ù†Ø¬Ø§Ø­',
        icon: 'success',
        timer: 1500,
        showConfirmButton: false
    });
    
    closeNotesModal();
}

// Ø¯Ø§Ù„Ø© Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ù„Ù‰ Excel
function exportNotesToExcel() {
    let notesData = [];
    
    for (let id in students) {
        const s = students[id];
        if (s.notes) {
            notesData.push({
                'ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨': id,
                'Ø§Ù„Ø§Ø³Ù…': s.name,
                'Ø§Ù„ØµÙ': s.main,
                'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©': s.group || '',
                'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª': s.notes
            });
        }
    }
    
    if (notesData.length === 0) {
        Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§', 'info');
        return;
    }
    
    const ws = XLSX.utils.json_to_sheet(notesData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª");
    XLSX.writeFile(wb, 'student_notes.xlsx');
}

// Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
function addNotesButtonToSidebar() {
    const sidebarMenu = document.querySelector('.sidebar-menu');
    if (sidebarMenu) {
        const notesItem = document.createElement('li');
        notesItem.innerHTML = `
            <a href="#" onclick="showAllNotes()">
                <i class="fas fa-sticky-note"></i> Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            </a>
        `;
        sidebarMenu.appendChild(notesItem);
    }
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.onload = function() {
    if (localStorage.getItem("isLoggedIn") === "true") {
        document.getElementById("loginScreen").style.display = "none";
        loadAllStudentsData();
        loadPosts();
        loadTrash();
        loadWeeklyReports();
        loadGroups();
        fillGradeSelects();
        fillGroupSelects();
        const today = new Date();
        document.getElementById('currentDate').textContent = today.toLocaleDateString('ar-EG');
        
        // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
        addNotesButtonToSidebar();
    }
};

// ... (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ Ø­ØªÙ‰ Ù†ØµÙ„ Ù„Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø°ÙŠ Ø³Ù†Ø¶ÙŠÙÙ‡)

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨
function showAttendanceDashboard() {
  // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø¬Ø¯ÙŠØ¯Ø©
  const attendanceModal = document.createElement('div');
  attendanceModal.className = 'modal';
  attendanceModal.id = 'attendanceDashboard';
  attendanceModal.innerHTML = `
    <div class="modal-content" style="max-width: 1000px;">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-calendar-check"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h3>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      
      <div class="modal-body">
        <div class="attendance-controls">
          <div class="filter-section">
            <select id="attendanceFilterGrade" class="form-control">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
              ${grades.map(grade => `<option value="${grade}">${grade}</option>`).join('')}
            </select>
            
            <select id="attendanceFilterGroup" class="form-control">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>
              ${groups.map(group => `<option value="${group}">${group}</option>`).join('')}
            </select>
            
            <select id="attendanceFilterDay" class="form-control">
              <option value="">Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ</option>
              ${weekDays.map(day => `<option value="${day}">${day}</option>`).join('')}
            </select>
            
            <button class="btn" onclick="filterAttendanceDashboard()">
              <i class="fas fa-filter"></i> ØªØµÙÙŠØ©
            </button>
          </div>
          
          <div class="stats-section">
            <div class="stat-item">
              <span class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨:</span>
              <span class="stat-value" id="totalStudentsStat">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Ø§Ù„Ø­Ø§Ø¶Ø±ÙˆÙ†:</span>
              <span class="stat-value present" id="presentStudentsStat">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Ø§Ù„ØºØ§Ø¦Ø¨ÙˆÙ†:</span>
              <span class="stat-value absent" id="absentStudentsStat">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Ù„Ø¯ÙŠÙ‡Ù… ÙˆØ§ØªØ³Ø§Ø¨:</span>
              <span class="stat-value" id="whatsappStudentsStat">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Ø¨Ø¯ÙˆÙ† ÙˆØ§ØªØ³Ø§Ø¨:</span>
              <span class="stat-value" id="noWhatsappStudentsStat">0</span>
            </div>
          </div>
        </div>
        
        <div class="attendance-actions">
          <button class="btn btn-success" onclick="markAllPresent()">
            <i class="fas fa-check-circle"></i> Ø­Ø¶ÙˆØ± Ø§Ù„ÙƒÙ„
          </button>
          <button class="btn btn-danger" onclick="markAllAbsent()">
            <i class="fas fa-times-circle"></i> ØºÙŠØ§Ø¨ Ø§Ù„ÙƒÙ„
          </button>
          <button class="btn btn-primary" onclick="sendAttendanceNotifications()">
            <i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
          </button>
          <button class="btn excel-btn" onclick="exportAttendanceDashboard()">
            <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel
          </button>
          <button class="btn" onclick="scanQRForAttendance()">
            <i class="fas fa-qrcode"></i> Ù…Ø³Ø­ QR Code
          </button>
        </div>
        
        <div class="students-list" id="attendanceStudentsList"></div>
        
        <div class="no-whatsapp-section" id="noWhatsappSection" style="display: none;">
          <h4><i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨</h4>
          <div class="no-whatsapp-list" id="noWhatsappList"></div>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(attendanceModal);
  document.getElementById('attendanceDashboard').style.display = 'block';
  
  // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
  const today = new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
  document.getElementById('attendanceFilterDay').value = today;
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨
  filterAttendanceDashboard();
}

// Ø¯Ø§Ù„Ø© Ù„ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ø¶ÙˆØ±
function filterAttendanceDashboard() {
  const grade = document.getElementById('attendanceFilterGrade').value;
  const group = document.getElementById('attendanceFilterGroup').value;
  const day = document.getElementById('attendanceFilterDay').value || 
              new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
  
  let html = '';
  let total = 0;
  let present = 0;
  let absent = 0;
  let hasWhatsapp = 0;
  let noWhatsapp = 0;
  let noWhatsappHtml = '';
  
  for (let id in students) {
    const s = students[id];
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
    if (grade && s.main !== grade) continue;
    if (group && s.group !== group) continue;
    
    total++;
    
    // Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ±
    const status = s.attendance && s.attendance[day] ? s.attendance[day] : '';
    
    // Ø¥Ø­ØµØ§Ø¡Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨
    if (s.phone || s.motherPhone) {
      hasWhatsapp++;
    } else {
      noWhatsapp++;
      noWhatsappHtml += `
        <div class="student-item no-whatsapp">
          <span>${s.name} (${id})</span>
          <span>${s.main}</span>
          <span>${s.group || 'Ø¨Ø¯ÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹Ø©'}</span>
        </div>
      `;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª
    if (status === 'Ø­Ø§Ø¶Ø±') present++;
    else absent++;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
    html += `
      <div class="student-item ${status === 'Ø­Ø§Ø¶Ø±' ? 'present' : status === 'ØºØ§Ø¦Ø¨' ? 'absent' : ''}">
        <div class="student-info">
          <span class="student-name">${s.name}</span>
          <span class="student-id">${id}</span>
          <span class="student-grade">${s.main}</span>
          <span class="student-group">${s.group || 'Ø¨Ø¯ÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹Ø©'}</span>
        </div>
        <div class="attendance-actions">
          <button class="btn btn-small btn-success ${status === 'Ø­Ø§Ø¶Ø±' ? 'active' : ''}" 
                  onclick="markStudentAttendance('${id}', 'Ø­Ø§Ø¶Ø±', '${day}')">
            <i class="fas fa-check"></i> Ø­Ø§Ø¶Ø±
          </button>
          <button class="btn btn-small btn-danger ${status === 'ØºØ§Ø¦Ø¨' ? 'active' : ''}" 
                  onclick="markStudentAttendance('${id}', 'ØºØ§Ø¦Ø¨', '${day}')">
            <i class="fas fa-times"></i> ØºØ§Ø¦Ø¨
          </button>
        </div>
      </div>
    `;
  }
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
  document.getElementById('attendanceStudentsList').innerHTML = html || '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</p>';
  document.getElementById('noWhatsappList').innerHTML = noWhatsappHtml || '<p>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ø¯ÙŠÙ‡Ù… Ø£Ø±Ù‚Ø§Ù… ÙˆØ§ØªØ³Ø§Ø¨</p>';
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª
  document.getElementById('totalStudentsStat').textContent = total;
  document.getElementById('presentStudentsStat').textContent = present;
  document.getElementById('absentStudentsStat').textContent = absent;
  document.getElementById('whatsappStudentsStat').textContent = hasWhatsapp;
  document.getElementById('noWhatsappStudentsStat').textContent = noWhatsapp;
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø¨Ø¯ÙˆÙ† ÙˆØ§ØªØ³Ø§Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø§Ø¨
  document.getElementById('noWhatsappSection').style.display = noWhatsapp > 0 ? 'block' : 'none';
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨ Ø·Ø§Ù„Ø¨
function markStudentAttendance(id, status, day) {
  if (!students[id]) return;
  
  if (!students[id].attendance) students[id].attendance = {};
  students[id].attendance[day] = status;
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
  filterAttendanceDashboard();
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨
function markAllPresent() {
  const day = document.getElementById('attendanceFilterDay').value || 
              new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
  
  for (let id in students) {
    if (!students[id].attendance) students[id].attendance = {};
    students[id].attendance[day] = 'Ø­Ø§Ø¶Ø±';
  }
  
  filterAttendanceDashboard();
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨
function markAllAbsent() {
  const day = document.getElementById('attendanceFilterDay').value || 
              new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
  
  for (let id in students) {
    if (!students[id].attendance) students[id].attendance = {};
    students[id].attendance[day] = 'ØºØ§Ø¦Ø¨';
  }
  
  filterAttendanceDashboard();
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
async function sendAttendanceNotifications() {
  const day = document.getElementById('attendanceFilterDay').value || 
              new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
  const date = new Date().toLocaleDateString('ar-EG');
  const time = new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});
  
  let sentCount = 0;
  let skippedCount = 0;
  
  for (let id in students) {
    const s = students[id];
    if (!s.attendance || !s.attendance[day]) continue;
    
    const status = s.attendance[day];
    let message = '';
    
    if (status === 'Ø­Ø§Ø¶Ø±') {
      message = `Ø§Ù„Ø³ÙŠØ¯ ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨: ${s.name}\n\n`
              + `Ù†Ø­ÙŠØ· Ø¹Ù„Ù…ÙƒÙ… Ø£Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ ${s.name} Ù‚Ø¯ Ø­Ø¶Ø± Ø§Ù„ÙŠÙˆÙ… ${day}\n`
              + `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${s.group || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`
              + `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}\n`
              + `Ø§Ù„ÙˆÙ‚Øª: ${time}\n\n`
              + `Ù†Ø´ÙƒØ±ÙƒÙ… Ø¹Ù„Ù‰ Ù…ØªØ§Ø¨Ø¹ØªÙƒÙ…`;
    } else {
      message = `Ø§Ù„Ø³ÙŠØ¯ ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨: ${s.name}\n\n`
              + `Ù†Ø­ÙŠØ· Ø¹Ù„Ù…ÙƒÙ… Ø£Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ ${s.name} Ù‚Ø¯ ØºØ§Ø¨ Ø§Ù„ÙŠÙˆÙ… ${day}\n`
              + `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${s.group || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`
              + `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}\n\n`
              + `Ù†Ø±Ø¬Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ ÙÙŠ Ø­Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±`;
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø£Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯
    if (s.phone) {
      sendWhatsAppNotification(s.phone, message);
      sentCount++;
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø£Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯
    if (s.motherPhone) {
      sendWhatsAppNotification(s.motherPhone, message);
      sentCount++;
    }
    
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø£ÙŠ Ø±Ù‚Ù…
    if (!s.phone && !s.motherPhone) {
      skippedCount++;
    }
  }
  
  Swal.fire({
    title: 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„',
    html: `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${sentCount} Ø¥Ø´Ø¹Ø§Ø±<br>`
        + `ØªÙ… ØªØ®Ø·ÙŠ ${skippedCount} Ø·Ø§Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨`,
    icon: 'success'
  });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø¥Ù„Ù‰ Excel
function exportAttendanceDashboard() {
  const day = document.getElementById('attendanceFilterDay').value || 
              new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
  const date = new Date().toLocaleDateString('ar-EG');
  
  let data = [];
  
  for (let id in students) {
    const s = students[id];
    const status = s.attendance && s.attendance[day] ? s.attendance[day] : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
    
    data.push({
      'ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨': id,
      'Ø§Ù„Ø§Ø³Ù…': s.name,
      'Ø§Ù„ØµÙ': s.main,
      'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©': s.group || '',
      'Ø§Ù„ÙŠÙˆÙ…': day,
      'Ø§Ù„Ø­Ø§Ù„Ø©': status,
      'Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ù„Ø£Ø¨)': s.phone || '',
      'Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ù„Ø£Ù…)': s.motherPhone || ''
    });
  }
  
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ±");
  XLSX.writeFile(wb, `attendance_report_${day}_${date.replace(/\//g, '-')}.xlsx`);
}

// Ø¯Ø§Ù„Ø© Ù„Ù…Ø³Ø­ QR Code Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±
async function scanQRForAttendance() {
  const day = document.getElementById('attendanceFilterDay').value || 
              new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
  
  try {
    const codeReader = new ZXing.BrowserQRCodeReader();
    const result = await codeReader.decodeFromInputVideoDevice(undefined, 'video');
    
    try {
      const qrData = JSON.parse(result.text);
      if (qrData.id && students[qrData.id]) {
        markStudentAttendance(qrData.id, 'Ø­Ø§Ø¶Ø±', day);
        Swal.fire({
          title: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„',
          html: `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ø§Ù„Ø¨ ${students[qrData.id].name}`,
          icon: 'success',
          timer: 2000
        });
      }
    } catch (e) {
      Swal.fire('Ø®Ø·Ø£', 'QR Code ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
    }
  } catch (error) {
    Swal.fire({
      title: 'Ù…Ø³Ø­ QR Code',
      html: `
        <div style="text-align: center;">
          <video id="qrScanner" style="width: 100%; max-width: 500px; border: 2px solid #1976d2; border-radius: 8px;"></video>
          <p>ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù…Ø³Ø­ QR Code</p>
        </div>
      `,
      showConfirmButton: false,
      didOpen: () => {
        const videoElement = document.getElementById('qrScanner');
        const codeReader = new ZXing.BrowserQRCodeReader();
        
        codeReader.decodeFromVideoDevice(undefined, videoElement, (result, err) => {
          if (result) {
            try {
              const qrData = JSON.parse(result.text);
              if (qrData.id && students[qrData.id]) {
                markStudentAttendance(qrData.id, 'Ø­Ø§Ø¶Ø±', day);
                Swal.fire({
                  title: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„',
                  html: `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ø§Ù„Ø¨ ${students[qrData.id].name}`,
                  icon: 'success',
                  timer: 2000
                }).then(() => {
                  codeReader.reset();
                });
              }
            } catch (e) {
              console.error('QR Code ØºÙŠØ± ØµØ§Ù„Ø­', e);
            }
          }
          
          if (err && !(err instanceof ZXing.NotFoundException)) {
            console.error('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‚Ø§Ø±Ø¦', err);
          }
        });
      },
      willClose: () => {
        const codeReader = new ZXing.BrowserQRCodeReader();
        codeReader.reset();
      }
    });
  }
}

// Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
function addAttendanceDashboardToSidebar() {
  const sidebarMenu = document.querySelector('.sidebar-menu');
  if (sidebarMenu) {
    const attendanceItem = document.createElement('li');
    attendanceItem.innerHTML = `
      <a href="#" onclick="showAttendanceDashboard()">
        <i class="fas fa-calendar-check"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨
      </a>
    `;
    sidebarMenu.appendChild(attendanceItem);
  }
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
window.onload = function() {
  if (localStorage.getItem("isLoggedIn") === "true") {
    document.getElementById("loginScreen").style.display = "none";
    loadAllStudentsData();
    loadPosts();
    loadTrash();
    loadWeeklyReports();
    loadGroups();
    fillGradeSelects();
    fillGroupSelects();
    const today = new Date();
    document.getElementById('currentDate').textContent = today.toLocaleDateString('ar-EG');
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    addAttendanceDashboardToSidebar();
    addNotesButtonToSidebar();
  }
};

// ... (Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ)

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© QR codes
function showQRCodesModal() {
  document.getElementById('qrCodesModal').style.display = 'block';
  fillGroupSelects(); // ØªØ¹Ø¨Ø¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
  filterQRCodes(); // Ø¹Ø±Ø¶ QR codes Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
}

// Ø¯Ø§Ù„Ø© Ù„ØªØµÙÙŠØ© ÙˆØ¹Ø±Ø¶ QR codes
function filterQRCodes() {
  const grade = document.getElementById('qrGradeFilter').value;
  const group = document.getElementById('qrGroupFilter').value;
  
  let html = '';
  let count = 0;
  
  for (let id in students) {
    const s = students[id];
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØªØµÙÙŠØ©
    if (grade && s.main !== grade) continue;
    if (group && s.group !== group) continue;
    
    count++;
    
    html += `
      <div class="qr-card" id="qr-card-${id}">
        <div class="qr-card-header">
          <h4>${s.name}</h4>
          <div class="student-info">
            <span>${s.main}</span>
            ${s.group ? `<span>${s.group}</span>` : ''}
          </div>
        </div>
        <div class="qr-code-container" id="qr-code-container-${id}"></div>
        <div class="qr-card-footer">
          <div class="teacher-name">Ø£/  Ø¹Ù„ÙŠ Ø®Ù„ÙŠÙÙ‡</div>
          <div class="teacher-subject">Ù…Ø¯Ø±Ø³ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠÙ‡</div>
        </div>
      </div>
    `;
  }
  
  document.getElementById('qrCardsContainer').innerHTML = html || '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</p>';
  
  // Ø¥Ù†Ø´Ø§Ø¡ QR codes Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨
  for (let id in students) {
    const s = students[id];
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØªØµÙÙŠØ©
    if (grade && s.main !== grade) continue;
    if (group && s.group !== group) continue;
    
    if (s.phone) {
      const qrContainer = document.getElementById(`qr-code-container-${id}`);
      if (qrContainer) {
        // Ù…Ø³Ø­ Ø£ÙŠ QR code Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§
        qrContainer.innerHTML = '';
        
        new QRCode(qrContainer, {
          text: JSON.stringify({
            id: id,
            phone: s.phone,
            action: 'attendance',
            group: s.group || 'default'
          }),
          width: 150,
          height: 150,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
      }
    }
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø·Ø§Ù‚Ø§Øª QR code
function printQRCodes() {
  const grade = document.getElementById('qrGradeFilter').value;
  const group = document.getElementById('qrGroupFilter').value;
  
  let printContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .qr-cards-page { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .qr-card { border: 1px solid #ddd; padding: 15px; text-align: center; page-break-inside: avoid; }
        .qr-card-header h4 { margin: 0 0 10px 0; }
        .student-info { margin-bottom: 10px; font-size: 14px; }
        .qr-code-container { margin: 10px 0; }
        .qr-card-footer { margin-top: 10px; font-size: 12px; }
        @media print {
          .qr-cards-page { grid-template-columns: repeat(3, 1fr); }
        }
      </style>
    </head>
    <body>
      <h2 style="text-align: center; margin-bottom: 20px;">Ø¨Ø·Ø§Ù‚Ø§Øª QR Code Ù„Ù„Ø·Ù„Ø§Ø¨</h2>
      <div class="qr-cards-page">
  `;
  
  for (let id in students) {
    const s = students[id];
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØªØµÙÙŠØ©
    if (grade && s.main !== grade) continue;
    if (group && s.group !== group) continue;
    
    printContent += `
      <div class="qr-card">
        <div class="qr-card-header">
          <h4>${s.name}</h4>
          <div class="student-info">
            <div>${s.main}</div>
            ${s.group ? `<div>${s.group}</div>` : ''}
          </div>
        </div>
        <div class="qr-code-container">
          <img src="${document.querySelector(`#qr-code-container-${id} img`).src}" width="150" height="150">
        </div>
        <div class="qr-card-footer">
          <div class="teacher-name">Ø£/  Ø¹Ù„ÙŠ Ø®Ù„ÙŠÙÙ‡</div>
          <div class="teacher-subject">Ù…Ø¯Ø±Ø³ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠÙ‡</div>
        </div>
      </div>
    `;
  }
  
  printContent += `
      </div>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
  
  setTimeout(() => {
    printWindow.print();
    printWindow.close();
  }, 500);
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ù… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
function hideStudentsOnLoad() {
  document.getElementById('studentsCards').innerHTML = `
    <div class="no-students">
      <h3><i class="fas fa-eye-slash"></i> Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ø®ÙÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
      <p>Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨" ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
      <button class="btn btn-success" onclick="showAllStudents()">
        <i class="fas fa-eye"></i> Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨
      </button>
    </div>
  `;
  document.getElementById('studentsCountNumber').textContent = '0';
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
window.onload = function() {
  if (localStorage.getItem("isLoggedIn") === "true") {
    document.getElementById("loginScreen").style.display = "none";
    loadAllStudentsData();
    loadPosts();
    loadTrash();
    loadWeeklyReports();
    loadGroups();
    fillGradeSelects();
    fillGroupSelects();
    const today = new Date();
    document.getElementById('currentDate').textContent = today.toLocaleDateString('ar-EG');
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
    hideStudentsOnLoad();
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    addAttendanceDashboardToSidebar();
    addNotesButtonToSidebar();
  }
};


function showError(msg) {
    Swal.fire('Ø®Ø·Ø£', msg, 'error');
}
</script>
</body>
</html
